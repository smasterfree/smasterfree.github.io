<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ovs学习 - smasterfree&#39;s blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="smasterfree" /><meta name="description" content="之前ovs学习相关记录。 基本概念 Packet 网络转发的最小数据单元，每个包都来自某个端口，最终会被发往一个或多个目标端口，转发数据包的过程就是网络的唯" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.81.0 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/ovs%E5%AD%A6%E4%B9%A0/ovs-%E5%AD%A6%E4%B9%A0/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.2108b3ca7cb9cc5b418ad4432696b017b9b8e08fe8cfe99653e8db4d6d3088b7.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="ovs学习" />
<meta property="og:description" content="之前ovs学习相关记录。 基本概念 Packet 网络转发的最小数据单元，每个包都来自某个端口，最终会被发往一个或多个目标端口，转发数据包的过程就是网络的唯" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/ovs%E5%AD%A6%E4%B9%A0/ovs-%E5%AD%A6%E4%B9%A0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-24T09:53:34&#43;08:00" />
<meta property="article:modified_time" content="2022-01-24T09:53:34&#43;08:00" />

<meta itemprop="name" content="ovs学习">
<meta itemprop="description" content="之前ovs学习相关记录。 基本概念 Packet 网络转发的最小数据单元，每个包都来自某个端口，最终会被发往一个或多个目标端口，转发数据包的过程就是网络的唯"><meta itemprop="datePublished" content="2022-01-24T09:53:34&#43;08:00" />
<meta itemprop="dateModified" content="2022-01-24T09:53:34&#43;08:00" />
<meta itemprop="wordCount" content="13103">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ovs学习"/>
<meta name="twitter:description" content="之前ovs学习相关记录。 基本概念 Packet 网络转发的最小数据单元，每个包都来自某个端口，最终会被发往一个或多个目标端口，转发数据包的过程就是网络的唯"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">smasterfree</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">smasterfree</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">ovs学习</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-24 </span>
        
          <span class="more-meta"> 13103 words </span>
          <span class="more-meta"> 27 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#基本概念">基本概念</a>
      <ul>
        <li><a href="#packet"><strong>Packet</strong></a></li>
        <li><a href="#bridge"><strong>Bridge</strong></a></li>
        <li><a href="#port"><strong>Port</strong></a></li>
        <li><a href="#interface"><strong>Interface</strong></a></li>
        <li><a href="#controller"><strong>Controller</strong></a></li>
        <li><a href="#flow"><strong>Flow</strong></a></li>
      </ul>
    </li>
    <li><a href="#基本操作">基本操作</a>
      <ul>
        <li><a href="#网桥操作">网桥操作</a></li>
        <li><a href="#port-操作"><strong>Port 操作</strong></a></li>
        <li><a href="#其他基本操作">其他基本操作</a></li>
        <li><a href="#ovs--相关命令快速指南">ovs-* 相关命令快速指南</a></li>
        <li><a href="#常用子命令说明">常用子命令说明</a></li>
      </ul>
    </li>
    <li><a href="#实验">实验</a>
      <ul>
        <li><a href="#单机无隔离网络"><strong>单机无隔离网络</strong></a></li>
        <li><a href="#单机隔离网络"><strong>单机隔离网络</strong></a></li>
        <li><a href="#分布式无隔离网络"><strong>分布式无隔离网络</strong></a></li>
        <li><a href="#vxlan实验环境-1">vxlan实验环境-1</a></li>
        <li><a href="#vxlan实验环境-2">vxlan实验环境-2</a></li>
      </ul>
    </li>
    <li><a href="#mininet">mininet</a>
      <ul>
        <li><a href="#基础">基础</a></li>
        <li><a href="#转发">转发</a></li>
        <li><a href="#实现路由">实现路由</a></li>
        <li><a href="#配置多流表实现路由">配置多流表实现路由</a></li>
        <li><a href="#无状态防火墙实现acl">无状态防火墙实现（acl）</a></li>
        <li><a href="#有状态防火墙实现-通过connection-tracking-conntrack">有状态防火墙实现-通过Connection Tracking (conntrack)</a></li>
        <li><a href="#qos实现">qos实现</a></li>
        <li><a href="#ovs-kernel-datapath">ovs Kernel Datapath</a></li>
        <li><a href="#vlan">vlan</a></li>
        <li><a href="#vlan-端口聚合-trunking">VLAN 端口聚合 (Trunking)</a></li>
        <li><a href="#实现gre-tunnel">实现gre tunnel</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>之前ovs学习相关记录。</p>
<h2 id="基本概念">基本概念</h2>
<p><img src="../images/image-20211028105357494.png" alt="image-20211028105357494"></p>
<h3 id="packet"><strong>Packet</strong></h3>
<p>网络转发的最小数据单元，每个包都来自某个端口，最终会被发往一个或多个目标端口，转发数据包的过程就是网络的唯一功能。</p>
<h3 id="bridge"><strong>Bridge</strong></h3>
<p>中文名称<strong>网桥</strong>，一个Bridge代表一个以太网交换机（Switch），一台主机中可以创建一个或多个Bridge，Bridge可以根据一定的规则，把某一个端口接收到的数据报文转发到另一个或多个端口上，也可以修改或者丢弃数据报文。</p>
<h3 id="port"><strong>Port</strong></h3>
<p>中文名称<strong>端口</strong>，需要注意的是它和TCP里面的端口不是同样的概念，它更像是物理交换机上面的插口，可以接水晶头的那种。</p>
<p>Port隶属于Bridge，必须先添加了Bridge才能在Bridge上添加Port。端口是收发数据包的单元。</p>
<p>OpenvSwitch中，每个端口都属于一个特定的网桥。端口收到的数据包会经过流规则的处理，发往其他端口；也会把其他端口来的数据包发送出去。</p>
<ul>
<li><strong>Normal</strong>
用户可以把操作系统中已有的网卡添加到Open vSwitch上，Open vSwitch会自动生成一个同名的Port开处理这张网卡进和出的数据报文。
不过需要注意的是这种方式添加的Port不支持分配IP地址，如果之前网卡上配置的有IP，挂载到OVS上面之后将不可访问。此类型的Port常用于VLAN模式的多台物理主机相连的那个口，交换机一端属于Trunk模式。</li>
<li><strong>Internal</strong>
当Port的类型是Internal时，OVS会自动创建一个虚拟网卡（Interface），此端口收到的数据报文都会转发给这块网卡，从这块网卡发出的数据报文也会通过Port交给OVS处理。当OVS创建一个新的网桥时，会自动创建一个与网桥同名的Internal Port，同时也会创建一个与网桥同名的Interface，因此可以通过ip命令在操作系统中查看到这张虚拟网卡，但是状态是down的。</li>
<li><strong>Patch</strong>
Patch Port和veth pair功能相同，总是成双成对的出现，在其中一端收到的数据报文会被转发到另一个Patch Port上，就像是一根网线一样。Patch Port常用于连接两个Bridge，这样两个网桥就和一个网桥一样了。</li>
<li><strong>Tunnel</strong>
OVS 支持 GRE、VXLAN、STT、Geneve和IPsec隧道协议，这些隧道协议就是overlay网络的基础协议，通过对物理网络做的一层封装和扩展，解决了二层网络数量不足的问题，最大限度的减少对底层物理网络拓扑的依赖性，同时也最大限度的增加了对网络的控制。</li>
</ul>
<h3 id="interface"><strong>Interface</strong></h3>
<p>接口是OVS与操作系统交换数据报文的组件，一个接口即是操作系统上的一块网卡，这个网卡可能是OVS生成的虚拟网卡，也有可能是挂载在OVS上的物理网卡，操作系统上的虚拟网卡（TUN/TAP）也可以被挂载在OVS上。</p>
<p>接口是ovs与外部交换数据包的组件。一个接口就是操作系统的一块网卡，这块网卡可能是ovs生成的虚拟网卡，也可能是物理网卡挂载在ovs上，也可能是操作系统的虚拟网卡（TUN/TAP）挂载在ovs上。</p>
<h3 id="controller"><strong>Controller</strong></h3>
<p>OpenFlow控制器，OVS可以接收一个或者多个OpenFlow控制器的管理，功能主要是下发流表，控制转发规则。</p>
<h3 id="flow"><strong>Flow</strong></h3>
<p>流表是OVS进行数据转发的核心功能，定义了端口之间转发数据报文的规则，一条流表规则主要分为匹配和动作两部分，匹配部分决定哪些数据报文需要被处理，动作决定了匹配到的数据报文该如何处理。</p>
<h2 id="基本操作">基本操作</h2>
<h3 id="网桥操作">网桥操作</h3>
<p>添加网桥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl add-br br-int
</code></pre></td></tr></table>
</div>
</div><p>查询网桥列表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@dgpubt-iaasqa-master-dzj:~# ovs-vsctl list-br
br-int
</code></pre></td></tr></table>
</div>
</div><p>删除网桥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl del-br br-int
</code></pre></td></tr></table>
</div>
</div><h3 id="port-操作"><strong>Port 操作</strong></h3>
<ul>
<li><strong>Normal Port</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 将物理网卡eth0添加到网桥br-int上</span>
ovs-vsctl add-port br-int eth0

<span class="c1"># 移除网桥br-int上的Port</span>
ovs-vsctl del-port br-int eth0
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Internal Port</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 添加Internal Port </span>
ovs-vsctl add-port br-int vnet0 -- <span class="nb">set</span> Interface vnet0 <span class="nv">type</span><span class="o">=</span>internal

<span class="c1"># 把网卡vnet0启动并配置IP</span>
ip link <span class="nb">set</span> vnet0 up
ip addr add 192.168.0.1/24 dev vnet0

<span class="c1"># 设置VLAN tag</span>
ovs-vsctl <span class="nb">set</span> Port vnet0 <span class="nv">tag</span><span class="o">=</span><span class="m">100</span>

<span class="c1"># 移除vnet0上面的VLAN tag配置</span>
ovs-vsctl remove Port vnet0 tag <span class="m">100</span>

<span class="c1"># 设置vnet0允许通过的VLAN tag</span>
ovs-vsctl <span class="nb">set</span> Port vnet0 <span class="nv">trunks</span><span class="o">=</span>100,200

<span class="c1"># 移除vnet0允许通过的的VLAN tag配置</span>
ovs-vsctl remove Port vnet0 trunks 100,200
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Patch Port</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl add-br br0
ovs-vsctl add-br br1
ovs-vsctl <span class="se">\
</span><span class="se"></span>-- add-port br0 patch0 -- <span class="nb">set</span> interface patch0 <span class="nv">type</span><span class="o">=</span>patch options:peer<span class="o">=</span>patch1 <span class="se">\
</span><span class="se"></span>-- add-port br1 patch1 -- <span class="nb">set</span> interface patch1 <span class="nv">type</span><span class="o">=</span>patch options:peer<span class="o">=</span>patch0
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Tunnel Port</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#主机10.1.7.21上</span>
ovs-vsctl add-br br-tun
ovs-vsctl add-port br-tun vxlan-vx01 -- <span class="nb">set</span> Interface vxlan-vx01 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>10.1.7.22 options:key<span class="o">=</span>flow
ovs-vsctl add-port br-tun vxlan-vx02 -- <span class="nb">set</span> Interface vxlan-vx02 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>10.1.7.23 options:key<span class="o">=</span>flow

<span class="c1">#主机10.1.7.22上</span>
ovs-vsctl add-br br-tun
ovs-vsctl add-port br-tun vxlan-vx01 -- <span class="nb">set</span> Interface vxlan-vx01 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>10.1.7.21 options:key<span class="o">=</span>flow
ovs-vsctl add-port br-tun vxlan-vx02 -- <span class="nb">set</span> Interface vxlan-vx02 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>10.1.7.23 options:key<span class="o">=</span>flow

<span class="c1">#主机10.1.7.23上</span>
ovs-vsctl add-br br-tun
ovs-vsctl add-port br-tun vxlan-vx01 -- <span class="nb">set</span> Interface vxlan-vx01 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>10.1.7.21 options:key<span class="o">=</span>flow
ovs-vsctl add-port br-tun vxlan-vx02 -- <span class="nb">set</span> Interface vxlan-vx02 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>10.1.7.22 options:key<span class="o">=</span>flow
</code></pre></td></tr></table>
</div>
</div><h3 id="其他基本操作">其他基本操作</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 设置VLAN mode</span>
ovs-vsctl <span class="nb">set</span> port &lt;port name&gt; <span class="nv">VLAN_mode</span><span class="o">=</span>trunk<span class="p">|</span>access<span class="p">|</span>native-tagged<span class="p">|</span>native-untagged

<span class="c1"># 设置VLAN tag</span>
ovs-vsctl <span class="nb">set</span> port &lt;port name&gt; <span class="nv">tag</span><span class="o">=</span>&lt;1-4095&gt;

<span class="c1"># 设置VLAN trunk</span>
ovs-vsctl <span class="nb">set</span> port &lt;port name&gt; <span class="nv">trunk</span><span class="o">=</span>100,200

<span class="c1"># 移除Port的属性</span>
ovs-vsctl remove port &lt;port name&gt; &lt;property name&gt; &lt;property value&gt;

<span class="c1"># 查看Port的属性</span>
ovs-vsctl list interface &lt;port name&gt;
</code></pre></td></tr></table>
</div>
</div><h3 id="ovs--相关命令快速指南">ovs-* 相关命令快速指南</h3>
<p>ovs命令行挺复杂的，提供多个命令，每个命令又有多个不同的子命令，刚刚接触会觉得一团糟，但仔细理解ovs架构和基本概念后会发现命令使用起来非常简单.</p>
<ol>
<li>ovs对每个组件都会单独提供一个命令行,所以命令行的功能都非常的专一,理解了组件的用途，也就记住了命令行的用途和大概的子命令.</li>
<li>命令行的子命令其实就是对数据库的CURD，而数据库表其实就是OVS的核心概念,如Bridge,Ports,FlowTables等.</li>
</ol>
<p><img src="../images/image-20211028102211727.png" alt="image-20211028102211727"></p>
<p>这是一张详细一点的架构图.</p>
<p>颜色深一点的线是数据包的处理过程，而浅颜色的是Management Workflow。可以很清晰的看到每个组件都会有专门的client与其进行交互。</p>
<p><strong>client与组件对应关系</strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>详细</th>
</tr>
</thead>
<tbody>
<tr>
<td>ovs-dpctl</td>
<td>datapath控制器,可以创建删除DP，控制DP中的FlowTables，最常使用show命令，其他很少手动操作</td>
</tr>
<tr>
<td>ovs-ofctl</td>
<td>流表控制器，控制bridge上的流表，查看端口统计信息等</td>
</tr>
<tr>
<td>ovsdb-tool</td>
<td>专门管理ovsdb的client</td>
</tr>
<tr>
<td>ovs-vsctl</td>
<td>最常用的命令,通过操作ovsdb去管理相关的bridge,ports什么的</td>
</tr>
<tr>
<td>ovs-appctl</td>
<td>这个可以直接与openvswitch daemon进行交互,上图中没有列出来,这么命令较少使用</td>
</tr>
</tbody>
</table>
<h3 id="常用子命令说明">常用子命令说明</h3>
<ul>
<li>
<p>ovs-dpctl <code>show -s</code></p>
</li>
<li>
<p>ovs-ofctl <code>show, dump-ports, dump-flows, add-flow, mod-flows, del-flows</code></p>
</li>
<li>
<p>ovsdb-tools <code>show-log -m</code></p>
</li>
<li>
<p>ovs-vsctl</p>
<ul>
<li>
<p><code>show</code> 显示数据库内容</p>
</li>
<li>
<p>关于桥的操作 <code>add-br, list-br, del-br, br-exists</code>.</p>
</li>
<li>
<p>关于port的操作 <code>list-ports, add-port, del-port, add-bond, port-to-br.</code></p>
</li>
<li>
<p>关于interface的操作 <code>list-ifaces, iface-to-br</code></p>
</li>
<li>
<p><code>ovs-vsctl list/set/get/add/remove/clear/destroy table record column [value]</code>, 常见的表有bridge，controller，interface，mirror，netflow，open_vswitch，port，qos，queue，ssl，sflow.</p>
</li>
</ul>
</li>
<li>
<p>ovs-appctl <code>list-commands, fdb/show, qos/show</code></p>
</li>
</ul>
<h2 id="实验">实验</h2>
<h3 id="单机无隔离网络"><strong>单机无隔离网络</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 添加网桥</span>
ovs-vsctl add-br br-int

<span class="c1"># 添加三个内部端口</span>
ovs-vsctl add-port br-int vnet0 -- <span class="nb">set</span> Interface vnet0 <span class="nv">type</span><span class="o">=</span>internal
ovs-vsctl add-port br-int vnet1 -- <span class="nb">set</span> Interface vnet1 <span class="nv">type</span><span class="o">=</span>internal
ovs-vsctl add-port br-int vnet2 -- <span class="nb">set</span> Interface vnet2 <span class="nv">type</span><span class="o">=</span>internal

<span class="c1"># 添加三个netns</span>
ip netns add ns0
ip netns add ns1
ip netns add ns2

<span class="c1"># 将内部端口分别移动到netns中</span>
ip link <span class="nb">set</span> vnet0 netns ns0
ip link <span class="nb">set</span> vnet1 netns ns1
ip link <span class="nb">set</span> vnet2 netns ns2

<span class="c1"># 启动端口并配置IP</span>
ip netns <span class="nb">exec</span> ns0 ip link <span class="nb">set</span> lo up
ip netns <span class="nb">exec</span> ns0 ip link <span class="nb">set</span> vnet0 up
ip netns <span class="nb">exec</span> ns0 ip addr add 10.0.0.1/24 dev vnet0

ip netns <span class="nb">exec</span> ns1 ip link <span class="nb">set</span> lo up
ip netns <span class="nb">exec</span> ns1 ip link <span class="nb">set</span> vnet1 up
ip netns <span class="nb">exec</span> ns1 ip addr add 10.0.0.2/24 dev vnet1

ip netns <span class="nb">exec</span> ns2 ip link <span class="nb">set</span> lo up
ip netns <span class="nb">exec</span> ns2 ip link <span class="nb">set</span> vnet2 up
ip netns <span class="nb">exec</span> ns2 ip addr add 10.0.0.3/24 dev vnet2
</code></pre></td></tr></table>
</div>
</div><p>ovs show</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@dgpubt-iaasqa-master-dzj:~# ovs-vsctl show
270d646b-7118-4bb8-be33-573d9c69918d
    Bridge br-int
        Port <span class="s2">&#34;vnet2&#34;</span>
            Interface <span class="s2">&#34;vnet2&#34;</span>
                type: internal
        Port br-int
            Interface br-int
                type: internal
        Port <span class="s2">&#34;vnet1&#34;</span>
            Interface <span class="s2">&#34;vnet1&#34;</span>
                type: internal
        Port <span class="s2">&#34;vnet0&#34;</span>
            Interface <span class="s2">&#34;vnet0&#34;</span>
                type: internal
    ovs_version: <span class="s2">&#34;2.6.10&#34;</span>

</code></pre></td></tr></table>
</div>
</div><p>测试可以互相 ping通</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@dgpubt-iaasqa-master-dzj:~# ip netns <span class="nb">exec</span> ns0 ping 10.0.0.2
PING 10.0.0.2 <span class="o">(</span>10.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.485 ms
^C
--- 10.0.0.2 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">1</span> received, 0% packet loss, <span class="nb">time</span> 0ms
rtt min/avg/max/mdev <span class="o">=</span> 0.485/0.485/0.485/0.000 ms
root@dgpubt-iaasqa-master-dzj:~# ip netns <span class="nb">exec</span> ns0 ping 10.0.0.1
PING 10.0.0.1 <span class="o">(</span>10.0.0.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.029 ms
<span class="m">64</span> bytes from 10.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.034 ms
^C
root@dgpubt-iaasqa-master-dzj:~# ip netns <span class="nb">exec</span> ns1 ping 10.0.0.3
PING 10.0.0.3 <span class="o">(</span>10.0.0.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.425 ms
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.031 ms
^C
--- 10.0.0.3 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1007ms
rtt min/avg/max/mdev <span class="o">=</span> 0.031/0.228/0.425/0.197 ms

</code></pre></td></tr></table>
</div>
</div><p>清理实验环境</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl del-br br-int
ip netns del ns0
ip netns del ns1
ip netns del ns2
</code></pre></td></tr></table>
</div>
</div><h3 id="单机隔离网络"><strong>单机隔离网络</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 设置vnet0的VLAN tag为100</span>
ovs-vsctl <span class="nb">set</span> Port vnet0 <span class="nv">tag</span><span class="o">=</span><span class="m">100</span>

<span class="c1"># 设置vnet1和vnet2的VLAN tag为200</span>
ovs-vsctl <span class="nb">set</span> Port vnet1 <span class="nv">tag</span><span class="o">=</span><span class="m">200</span>
ovs-vsctl <span class="nb">set</span> Port vnet2 <span class="nv">tag</span><span class="o">=</span><span class="m">200</span>
</code></pre></td></tr></table>
</div>
</div><p>ovs-vsctl show</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@dgpubt-iaasqa-master-dzj:~# ovs-vsctl show
270d646b-7118-4bb8-be33-573d9c69918d
    Bridge br-int
        Port <span class="s2">&#34;vnet2&#34;</span>
            tag: <span class="m">200</span>
            Interface <span class="s2">&#34;vnet2&#34;</span>
                type: internal
        Port br-int
            Interface br-int
                type: internal
        Port <span class="s2">&#34;vnet1&#34;</span>
            tag: <span class="m">200</span>
            Interface <span class="s2">&#34;vnet1&#34;</span>
                type: internal
        Port <span class="s2">&#34;vnet0&#34;</span>
            tag: <span class="m">100</span>
            Interface <span class="s2">&#34;vnet0&#34;</span>
                type: internal
    ovs_version: <span class="s2">&#34;2.6.10&#34;</span>

</code></pre></td></tr></table>
</div>
</div><p>测试：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@dgpubt-iaasqa-master-dzj:~# ip netns <span class="nb">exec</span> ns0 ping 10.0.0.2
PING 10.0.0.2 <span class="o">(</span>10.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
^C
--- 10.0.0.2 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 0ms

root@dgpubt-iaasqa-master-dzj:~# ip netns <span class="nb">exec</span> ns0 ping 10.0.0.3
PING 10.0.0.3 <span class="o">(</span>10.0.0.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
^C
--- 10.0.0.3 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 0ms

root@dgpubt-iaasqa-master-dzj:~#
root@dgpubt-iaasqa-master-dzj:~#
root@dgpubt-iaasqa-master-dzj:~# ip netns <span class="nb">exec</span> ns1 ping 10.0.0.3
PING 10.0.0.3 <span class="o">(</span>10.0.0.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.490 ms
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.023 ms
^C
--- 10.0.0.3 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1031ms
rtt min/avg/max/mdev <span class="o">=</span> 0.023/0.256/0.490/0.234 ms

</code></pre></td></tr></table>
</div>
</div><p><code>ns0</code>是无法访问到<code>ns1</code>和<code>ns2</code>的，<code>ns1</code>和<code>ns2</code>可以互相访问。这是因为端口<code>vnet0</code>的数据报文发出后被OVS修改了包头，增加了VLAN <code>100</code>标签，与<code>vnet1</code>、<code>vnet2</code>的VLAN <code>200</code>标签不匹配，OVS交换机便不再将<code>vnet0</code>的数据报文发送给其他两个端口，由此便实现了网络隔离。</p>
<p>清理实验环境</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl del-br br-int
ip netns del ns0
ip netns del ns1
ip netns del ns2
</code></pre></td></tr></table>
</div>
</div><h3 id="分布式无隔离网络"><strong>分布式无隔离网络</strong></h3>
<p><img src="../images/image-20211028140651887.png" alt="image-20211028140651887"></p>
<ul>
<li>配置环境 <code>主机A</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl add-br br-int
<span class="c1"># 请修改eth1为当前实验环境的业务网卡名称</span>
ovs-vsctl add-port br-int eth1

<span class="c1"># 添加两个内部端口</span>
ovs-vsctl add-port br-int vnet0 -- <span class="nb">set</span> Interface vnet0 <span class="nv">type</span><span class="o">=</span>internal
ovs-vsctl add-port br-int vnet1 -- <span class="nb">set</span> Interface vnet1 <span class="nv">type</span><span class="o">=</span>internal
<span class="c1"># 添加两个netns</span>
ip netns add ns0
ip netns add ns1
<span class="c1"># 将内部端口分别移动到netns中</span>
ip link <span class="nb">set</span> vnet0 netns ns0
ip link <span class="nb">set</span> vnet1 netns ns1

<span class="c1"># 启动端口并配置IP</span>
ip netns <span class="nb">exec</span> ns0 ip link <span class="nb">set</span> lo up
ip netns <span class="nb">exec</span> ns0 ip link <span class="nb">set</span> vnet0 up
ip netns <span class="nb">exec</span> ns0 ip addr add 10.0.0.1/24 dev vnet0

ip netns <span class="nb">exec</span> ns1 ip link <span class="nb">set</span> lo up
ip netns <span class="nb">exec</span> ns1 ip link <span class="nb">set</span> vnet1 up
ip netns <span class="nb">exec</span> ns1 ip addr add 10.0.0.2/24 dev vnet1
</code></pre></td></tr></table>
</div>
</div><ul>
<li>配置环境 <code>主机B</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"> ovs-vsctl add-br br-int
 <span class="c1"># 请修改eth1为当前实验环境的业务网卡名称</span>
 ovs-vsctl add-port br-int eth1
 
 <span class="c1"># 添加两个内部端口</span>
 ovs-vsctl add-port br-int vnet0 -- <span class="nb">set</span> Interface vnet0 <span class="nv">type</span><span class="o">=</span>internal
 ovs-vsctl add-port br-int vnet1 -- <span class="nb">set</span> Interface vnet1 <span class="nv">type</span><span class="o">=</span>internal
 <span class="c1"># 添加两个netns</span>
 ip netns add ns0
 ip netns add ns1
 <span class="c1"># 将内部端口分别移动到netns中</span>
 ip link <span class="nb">set</span> vnet0 netns ns0
 ip link <span class="nb">set</span> vnet1 netns ns1
 
 <span class="c1"># 启动端口并配置IP</span>
 ip netns <span class="nb">exec</span> ns0 ip link <span class="nb">set</span> lo up
 ip netns <span class="nb">exec</span> ns0 ip link <span class="nb">set</span> vnet0 up
 ip netns <span class="nb">exec</span> ns0 ip addr add 10.0.0.3/24 dev vnet0
 
 ip netns <span class="nb">exec</span> ns1 ip link <span class="nb">set</span> lo up
 ip netns <span class="nb">exec</span> ns1 ip link <span class="nb">set</span> vnet1 up
 ip netns <span class="nb">exec</span> ns1 ip addr add 10.0.0.4/24 dev vnet1
</code></pre></td></tr></table>
</div>
</div><h3 id="vxlan实验环境-1">vxlan实验环境-1</h3>
<p>同网段互通</p>
<h4 id="测试环境">测试环境</h4>
<ul>
<li>VM1：192.168.0.15</li>
<li>VM2：192.168.0.14</li>
</ul>
<h4 id="操作方法">操作方法</h4>
<ul>
<li>步骤一：分别在两个机器上创建网桥，并配置虚拟ip</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">VM1:
ovs-vsctl add-br br0
ifconfig br0 30.0.0.3/8 up

VM2:
ovs-vsctl add-br br0
ifconfig br0 30.0.0.2/8 up
</code></pre></td></tr></table>
</div>
</div><ul>
<li>步骤二：验证网桥之间的连通性，此时应该是不通的</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@lxf-vxlan1:~# ping 30.0.0.2
PING 30.0.0.2 <span class="o">(</span>30.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
^C
--- 30.0.0.2 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 1005ms

</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>步骤三：搭建隧道实现通信</p>
<ul>
<li>
<p>在VM1上创建vxlan</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ovs-vsctl add-port br0 vx1 -- <span class="nb">set</span> interface vx1 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>192.168.0.14
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在VM2上创建vxlan</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ovs-vsctl add-port br0 vx1 -- <span class="nb">set</span> interface vx1 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>192.168.0.15
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>步骤四：验证连通性，设置VxLAN后，两个虚拟机的同一网段数据层面是通信的。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@lxf-vxlan1:~# ping 30.0.0.2
PING 30.0.0.2 <span class="o">(</span>30.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 30.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.87 ms
<span class="m">64</span> bytes from 30.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.165 ms
<span class="m">64</span> bytes from 30.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.306 ms
<span class="m">64</span> bytes from 30.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.314 ms
^C
--- 30.0.0.2 ping statistics ---
<span class="m">4</span> packets transmitted, <span class="m">4</span> received, 0% packet loss, <span class="nb">time</span> 3049ms
rtt min/avg/max/mdev <span class="o">=</span> 0.165/0.665/1.878/0.703 ms
root@lxf-vxlan1:~#
</code></pre></td></tr></table>
</div>
</div><h4 id="ovs-vsctl-show">ovs-vsctl show</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@haproxy-test-3:~# ovs-vsctl show
dfb4e8ed-1e8f-4219-8780-f88e883df3fa
    Bridge <span class="s2">&#34;br0&#34;</span>
        Port <span class="s2">&#34;br0&#34;</span>
            Interface <span class="s2">&#34;br0&#34;</span>
                type: internal
        Port <span class="s2">&#34;vx1&#34;</span>
            Interface <span class="s2">&#34;vx1&#34;</span>
                type: vxlan
                options: <span class="o">{</span><span class="nv">remote_ip</span><span class="o">=</span><span class="s2">&#34;192.168.0.14&#34;</span><span class="o">}</span>
    ovs_version: <span class="s2">&#34;2.6.2&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="ip-a">ip a</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@haproxy-test-3:~# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast state UP group default qlen <span class="m">1000</span>
    link/ether fa:16:3e:fd:d6:05 brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.15/20 brd 192.168.15.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fefd:d605/64 scope link
       valid_lft forever preferred_lft forever
3: ovs-system: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc noop state DOWN group default qlen <span class="m">1000</span>
    link/ether a6:cf:15:f6:d6:28 brd ff:ff:ff:ff:ff:ff
4: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
    link/ether aa:ed:c9:fe:e6:46 brd ff:ff:ff:ff:ff:ff
    inet 30.0.0.3/8 brd 30.255.255.255 scope global br0
       valid_lft forever preferred_lft forever
    inet6 fe80::a8ed:c9ff:fefe:e646/64 scope link
       valid_lft forever preferred_lft forever
5: vxlan_sys_4789: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">65485</span> qdisc noqueue master ovs-system state UNKNOWN group default qlen <span class="m">1000</span>
    link/ether 9e:d9:b0:cb:d2:19 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::9cd9:b0ff:fecb:d219/64 scope link
       valid_lft forever preferred_lft forever
</code></pre></td></tr></table>
</div>
</div><p>清理实验环境</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ovs-vsctl del-br br0
</code></pre></td></tr></table>
</div>
</div><h3 id="vxlan实验环境-2">vxlan实验环境-2</h3>
<p>机器还是这两台</p>
<h4 id="测试环境-1">测试环境</h4>
<ul>
<li>VM1：192.168.0.15</li>
<li>VM2：192.168.0.14</li>
</ul>
<h4 id="创建网桥">创建网桥</h4>
<p>分别在两个机器上创建网桥，并配置虚拟ip</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">VM1:
ovs-vsctl add-br br0
ifconfig br0 20.0.0.1/8 up

VM2:
ovs-vsctl add-br br0
ifconfig br0 30.0.0.1/8 up
</code></pre></td></tr></table>
</div>
</div><p>此时网桥连通性是不通的</p>
<h4 id="搭建隧道配通">搭建隧道配通</h4>
<p>vm1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ovs-vsctl add-port br0 vx1 -- <span class="nb">set</span> interface vx1 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>192.168.0.14
</code></pre></td></tr></table>
</div>
</div><p>vm2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ovs-vsctl add-port br0 vx1 -- <span class="nb">set</span> interface vx1 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>192.168.0.15
</code></pre></td></tr></table>
</div>
</div><p>此时因为是跨网段的，还是互相不能ping通</p>
<h4 id="增加路由">增加路由</h4>
<p>vm1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">route add -net 30.0.0.0 netmask 255.0.0.0 gw 20.0.0.1 dev br0
</code></pre></td></tr></table>
</div>
</div><p>vm2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">route add -net 20.0.0.0 netmask 255.0.0.0 gw 30.0.0.1 dev br0
</code></pre></td></tr></table>
</div>
</div><p>这是可以ping通</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@haproxy-test-1:~# ping 20.0.0.1
PING 20.0.0.1 <span class="o">(</span>20.0.0.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 20.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>7.25 ms
<span class="m">64</span> bytes from 20.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.385 ms
<span class="m">64</span> bytes from 20.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.387 ms
^C
--- 20.0.0.1 ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2006ms
rtt min/avg/max/mdev <span class="o">=</span> 0.385/2.677/7.259/3.239 ms
</code></pre></td></tr></table>
</div>
</div><h2 id="mininet">mininet</h2>
<h3 id="基础">基础</h3>
<p>mininet是什么</p>
<p><img src="../images/image-20211105144354161.png" alt="image-20211105144354161"></p>
<p><img src="../images/image-20211105144404011.png" alt="image-20211105144404011"></p>
<h4 id="mn-默认进去的网络拓扑">mn 默认进去的网络拓扑</h4>
<p><img src="../images/image-20211028100003679.png" alt="image-20211028100003679"></p>
<p>mininet：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt;
mininet&gt; nodes
available nodes are:
h1 h2 s1
mininet&gt; dump
&lt;Host h1: h1-eth0:10.0.0.1 <span class="nv">pid</span><span class="o">=</span>33812&gt;
&lt;Host h2: h2-eth0:10.0.0.2 <span class="nv">pid</span><span class="o">=</span>33814&gt;
&lt;OVSBridge s1: lo:127.0.0.1,s1-eth1:None,s1-eth2:None <span class="nv">pid</span><span class="o">=</span>33819&gt;
mininet&gt;
mininet&gt; net
h1 h1-eth0:s1-eth1
h2 h2-eth0:s1-eth2
s1 lo:  s1-eth1:h1-eth0 s1-eth2:h2-eth0
mininet&gt;
</code></pre></td></tr></table>
</div>
</div><h4 id="mininet自定义网络拓扑">mininet自定义网络拓扑</h4>
<p>这个比较简单，加上各个元素，然后连接起来就ok。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">mininet.topo</span> <span class="kn">import</span> <span class="n">Topo</span>

<span class="k">class</span> <span class="nc">MyTopo</span><span class="p">(</span> <span class="n">Topo</span> <span class="p">):</span>
    <span class="s2">&#34;Simple topology example.&#34;</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="s2">&#34;Create custom topo.&#34;</span>

        <span class="c1"># Add hosts and switches; custom ip mac</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h1&#39;</span> <span class="p">,</span><span class="n">ip</span><span class="o">=</span><span class="s1">&#39;10.0.0.1/24&#39;</span><span class="p">,</span> <span class="n">mac</span><span class="o">=</span><span class="s1">&#39;00:00:00:00:00:01&#39;</span><span class="p">)</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h2&#39;</span> <span class="p">,</span><span class="n">ip</span><span class="o">=</span><span class="s1">&#39;20.0.0.1/24&#39;</span><span class="p">,</span> <span class="n">mac</span><span class="o">=</span><span class="s1">&#39;00:00:00:00:00:02&#39;</span><span class="p">)</span>
        <span class="n">h3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h3&#39;</span> <span class="p">,</span><span class="n">ip</span><span class="o">=</span><span class="s1">&#39;10.0.0.2/24&#39;</span><span class="p">,</span> <span class="n">mac</span><span class="o">=</span><span class="s1">&#39;00:00:00:00:00:03&#39;</span><span class="p">)</span>
        <span class="n">h4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h4&#39;</span> <span class="p">,</span><span class="n">ip</span><span class="o">=</span><span class="s1">&#39;20.0.0.2/24&#39;</span><span class="p">,</span> <span class="n">mac</span><span class="o">=</span><span class="s1">&#39;00:00:00:00:00:04&#39;</span><span class="p">)</span>

        <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span> <span class="s1">&#39;s1&#39;</span> <span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span> <span class="s1">&#39;s2&#39;</span> <span class="p">)</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span> <span class="s1">&#39;s3&#39;</span> <span class="p">)</span>

        <span class="c1"># Add links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h1</span><span class="p">,</span> <span class="n">s1</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h2</span><span class="p">,</span> <span class="n">s1</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h3</span><span class="p">,</span> <span class="n">s2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h4</span><span class="p">,</span> <span class="n">s2</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s3</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span> <span class="p">)</span>

<span class="n">topos</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;mytopo&#39;</span><span class="p">:</span> <span class="p">(</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">MyTopo</span><span class="p">()</span> <span class="p">)</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="ovs-show">ovs show</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@dgpubt-iaasqa-master-dzj:~# ovs-vsctl show
270d646b-7118-4bb8-be33-573d9c69918d
    Bridge <span class="s2">&#34;s1&#34;</span>
        Controller <span class="s2">&#34;ptcp:6634&#34;</span>
        fail_mode: standalone
        Port <span class="s2">&#34;s1-eth1&#34;</span>
            Interface <span class="s2">&#34;s1-eth1&#34;</span>
        Port <span class="s2">&#34;s1&#34;</span>
            Interface <span class="s2">&#34;s1&#34;</span>
                type: internal
        Port <span class="s2">&#34;s1-eth2&#34;</span>
            Interface <span class="s2">&#34;s1-eth2&#34;</span>
    ovs_version: <span class="s2">&#34;2.6.10&#34;</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="dump-flow">dump flow</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~#  ovs-ofctl dump-flows s1
NXST_FLOW reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x4<span class="o">)</span>:
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>3.545s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>10, <span class="nv">n_bytes</span><span class="o">=</span>836, <span class="nv">idle_age</span><span class="o">=</span>0, <span class="nv">priority</span><span class="o">=</span><span class="m">0</span> <span class="nv">actions</span><span class="o">=</span>NORMAL
</code></pre></td></tr></table>
</div>
</div><ul>
<li>cookie    64位数字，关联一个具体的flow。在新增，变更流表的时候可以设置。 default 是0x0</li>
<li>duration  此条被加入的时间 seconds</li>
<li>table 表号</li>
<li>n_packets   命中这个entry的packet</li>
<li>n_bytes 命中这个entry的bytes</li>
<li>priority  0到65535 之间。</li>
<li>action normal就是 l2/l3 处理。</li>
</ul>
<h4 id="switch-状态">switch 状态</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-ofctl show s1
OFPT_FEATURES_REPLY <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x2<span class="o">)</span>: dpid:0000000000000001
n_tables:254, n_buffers:256
capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP
actions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst
 1<span class="o">(</span>s1-eth1<span class="o">)</span>: addr:ea:1b:a8:f0:f7:d4
     config:     <span class="m">0</span>
     state:      <span class="m">0</span>
     current:    10GB-FD COPPER
     speed: <span class="m">10000</span> Mbps now, <span class="m">0</span> Mbps max
 2<span class="o">(</span>s1-eth2<span class="o">)</span>: addr:7e:14:c4:fa:58:7a
     config:     <span class="m">0</span>
     state:      <span class="m">0</span>
     current:    10GB-FD COPPER
     speed: <span class="m">10000</span> Mbps now, <span class="m">0</span> Mbps max
 LOCAL<span class="o">(</span>s1<span class="o">)</span>: addr:26:e1:10:81:8c:44
     config:     PORT_DOWN
     state:      LINK_DOWN
     speed: <span class="m">0</span> Mbps now, <span class="m">0</span> Mbps max
OFPT_GET_CONFIG_REPLY <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x4<span class="o">)</span>: <span class="nv">frags</span><span class="o">=</span>normal <span class="nv">miss_send_len</span><span class="o">=</span><span class="m">0</span>

</code></pre></td></tr></table>
</div>
</div><p>switch 有3个interface ，包含mac地址等信息</p>
<h4 id="查看learned-mac地址">查看learned mac地址</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-appctl fdb/show s1
 port  VLAN  MAC                Age
    <span class="m">2</span>     <span class="m">0</span>  ca:fe:44:19:9a:22    <span class="m">1</span>
    <span class="m">1</span>     <span class="m">0</span>  3a:9e:9d:49:d1:05    <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 和h1 里面ip a mac 对应 3a:9e:9d:49:d1:05</span>
mininet&gt; h1 ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: h1-eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default qlen <span class="m">1000</span>
    link/ether 3a:9e:9d:49:d1:05 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span>
    inet 10.0.0.1/8 brd 10.255.255.255 scope global h1-eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::389e:9dff:fe49:d105/64 scope link
       valid_lft forever preferred_lft forever

</code></pre></td></tr></table>
</div>
</div><h4 id="dump-flow-info">dump flow info</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-ofctl dump-ports s1
OFPST_PORT reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x2<span class="o">)</span>: <span class="m">3</span> ports
  port LOCAL: rx <span class="nv">pkts</span><span class="o">=</span>0, <span class="nv">bytes</span><span class="o">=</span>0, <span class="nv">drop</span><span class="o">=</span>29, <span class="nv">errs</span><span class="o">=</span>0, <span class="nv">frame</span><span class="o">=</span>0, <span class="nv">over</span><span class="o">=</span>0, <span class="nv">crc</span><span class="o">=</span><span class="m">0</span>
           tx <span class="nv">pkts</span><span class="o">=</span>0, <span class="nv">bytes</span><span class="o">=</span>0, <span class="nv">drop</span><span class="o">=</span>0, <span class="nv">errs</span><span class="o">=</span>0, <span class="nv">coll</span><span class="o">=</span><span class="m">0</span>
  port  1: rx <span class="nv">pkts</span><span class="o">=</span>103, <span class="nv">bytes</span><span class="o">=</span>9482, <span class="nv">drop</span><span class="o">=</span>0, <span class="nv">errs</span><span class="o">=</span>0, <span class="nv">frame</span><span class="o">=</span>0, <span class="nv">over</span><span class="o">=</span>0, <span class="nv">crc</span><span class="o">=</span><span class="m">0</span>
           tx <span class="nv">pkts</span><span class="o">=</span>117, <span class="nv">bytes</span><span class="o">=</span>10530, <span class="nv">drop</span><span class="o">=</span>0, <span class="nv">errs</span><span class="o">=</span>0, <span class="nv">coll</span><span class="o">=</span><span class="m">0</span>
  port  2: rx <span class="nv">pkts</span><span class="o">=</span>103, <span class="nv">bytes</span><span class="o">=</span>9482, <span class="nv">drop</span><span class="o">=</span>0, <span class="nv">errs</span><span class="o">=</span>0, <span class="nv">frame</span><span class="o">=</span>0, <span class="nv">over</span><span class="o">=</span>0, <span class="nv">crc</span><span class="o">=</span><span class="m">0</span>
           tx <span class="nv">pkts</span><span class="o">=</span>117, <span class="nv">bytes</span><span class="o">=</span>10530, <span class="nv">drop</span><span class="o">=</span>0, <span class="nv">errs</span><span class="o">=</span>0, <span class="nv">coll</span><span class="o">=</span><span class="m">0</span>


root@jiande1-dgw-jiande1:~# ovs-ofctl dump-aggregate s1
NXST_AGGREGATE reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x4<span class="o">)</span>: <span class="nv">packet_count</span><span class="o">=</span><span class="m">204</span> <span class="nv">byte_count</span><span class="o">=</span><span class="m">18784</span> <span class="nv">flow_count</span><span class="o">=</span><span class="m">1</span>


</code></pre></td></tr></table>
</div>
</div><h4 id="查看flow-table">查看flow table</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl dump-tables s1

OFPST_TABLE reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x2<span class="o">)</span>:
  table <span class="m">0</span> <span class="o">(</span><span class="s2">&#34;classifier&#34;</span><span class="o">)</span>:
    <span class="nv">active</span><span class="o">=</span>1, <span class="nv">lookup</span><span class="o">=</span>33, <span class="nv">matched</span><span class="o">=</span><span class="m">33</span>
    <span class="nv">max_entries</span><span class="o">=</span><span class="m">1000000</span>
    matching:
      in_port: exact match or wildcard
      eth_src: exact match or wildcard
      eth_dst: exact match or wildcard
      eth_type: exact match or wildcard
      vlan_vid: exact match or wildcard
      vlan_pcp: exact match or wildcard
      ip_src: exact match or wildcard
      ip_dst: exact match or wildcard
      nw_proto: exact match or wildcard
      nw_tos: exact match or wildcard
      tcp_src: exact match or wildcard
      tcp_dst: exact match or wildcard

  table <span class="m">1</span> <span class="o">(</span><span class="s2">&#34;table1&#34;</span><span class="o">)</span>:
    <span class="nv">active</span><span class="o">=</span>0, <span class="nv">lookup</span><span class="o">=</span>0, <span class="nv">matched</span><span class="o">=</span><span class="m">0</span>
    <span class="o">(</span>same features<span class="o">)</span>

  table <span class="m">2</span> <span class="o">(</span><span class="s2">&#34;table2&#34;</span><span class="o">)</span>: ditto
  table <span class="m">3</span> <span class="o">(</span><span class="s2">&#34;table3&#34;</span><span class="o">)</span>: ditto
  table <span class="m">4</span> <span class="o">(</span><span class="s2">&#34;table4&#34;</span><span class="o">)</span>: ditto
  table <span class="m">5</span> <span class="o">(</span><span class="s2">&#34;table5&#34;</span><span class="o">)</span>: ditto
  table <span class="m">6</span> <span class="o">(</span><span class="s2">&#34;table6&#34;</span><span class="o">)</span>: ditto

</code></pre></td></tr></table>
</div>
</div><h4 id="删除flow">删除flow</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl del-flows s1
</code></pre></td></tr></table>
</div>
</div><p>这个时候的确ping不通了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping h2
PING 10.0.0.2 <span class="o">(</span>10.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
^C
--- 10.0.0.2 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 0ms
</code></pre></td></tr></table>
</div>
</div><h3 id="转发">转发</h3>
<h4 id="enable-traffic-forward-use-layer1-data">enable traffic forward use layer1 data</h4>
<p>加入流表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="nv">in_port</span><span class="o">=</span>1,action<span class="o">=</span>output:2
ovs-ofctl add-flow s1 <span class="nv">in_port</span><span class="o">=</span>2,action<span class="o">=</span>output:1
</code></pre></td></tr></table>
</div>
</div><p>可以ping通。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-ofctl dump-flows s1
NXST_FLOW reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x4<span class="o">)</span>:
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>66.560s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>18, <span class="nv">n_bytes</span><span class="o">=</span>924, <span class="nv">idle_age</span><span class="o">=</span>22, <span class="nv">in_port</span><span class="o">=</span><span class="m">1</span> <span class="nv">actions</span><span class="o">=</span>output:2
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>27.518s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>5, <span class="nv">n_bytes</span><span class="o">=</span>378, <span class="nv">idle_age</span><span class="o">=</span>22, <span class="nv">in_port</span><span class="o">=</span><span class="m">2</span> <span class="nv">actions</span><span class="o">=</span>output:1
</code></pre></td></tr></table>
</div>
</div><p>删除flow</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl del-flows s1
</code></pre></td></tr></table>
</div>
</div><h4 id="enable-traffic-forward-use-layer2-data">enable traffic forward use layer2 data</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="nv">dl_dst</span><span class="o">=</span>3a:9e:9d:49:d1:05,action<span class="o">=</span>output:1
</code></pre></td></tr></table>
</div>
</div><p>Traffic going to the destination host h1 will be forwarded to switch port s1-eth1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="nv">dl_dst</span><span class="o">=</span>ca:fe:44:19:9a:22,action<span class="o">=</span>output:2
</code></pre></td></tr></table>
</div>
</div><p>Consider the figure above. The flow specifies that the switch will match against MAC address. Traffic going to the destination host h2 will be forwarded to switch port s1-eth2.</p>
<p>现在还不能互相ping通。因为ping是在ip层工作的。</p>
<p>加入arp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 arp,action<span class="o">=</span>normal
</code></pre></td></tr></table>
</div>
</div><p>这个时候就可以ping通了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h2 ping h1
PING 10.0.0.1 <span class="o">(</span>10.0.0.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.271 ms
<span class="m">64</span> bytes from 10.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.071 ms
^C
--- 10.0.0.1 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1000ms
rtt min/avg/max/mdev <span class="o">=</span> 0.071/0.171/0.271/0.100 ms
mininet&gt;

</code></pre></td></tr></table>
</div>
</div><p>删除flow</p>
<h4 id="enable-traffic-forward-use-layer3-data">enable traffic forward use layer3 data</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-ofctl add-flow s1 ip,nw_dst<span class="o">=</span>10.0.0.1,action<span class="o">=</span>output:1
root@jiande1-dgw-jiande1:~# ovs-ofctl add-flow s1 ip,nw_dst<span class="o">=</span>10.0.0.2,action<span class="o">=</span>output:2
root@jiande1-dgw-jiande1:~# ovs-ofctl add-flow s1 arp,action<span class="o">=</span>normal
</code></pre></td></tr></table>
</div>
</div><p>可以ping 通了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-ofctl dump-flows s1
NXST_FLOW reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x4<span class="o">)</span>:
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>91.559s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>5, <span class="nv">n_bytes</span><span class="o">=</span>490, <span class="nv">idle_age</span><span class="o">=</span>50, ip,nw_dst<span class="o">=</span>10.0.0.1 <span class="nv">actions</span><span class="o">=</span>output:1
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>85.167s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>5, <span class="nv">n_bytes</span><span class="o">=</span>490, <span class="nv">idle_age</span><span class="o">=</span>50, ip,nw_dst<span class="o">=</span>10.0.0.2 <span class="nv">actions</span><span class="o">=</span>output:2
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>52.351s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>5, <span class="nv">n_bytes</span><span class="o">=</span>210, <span class="nv">idle_age</span><span class="o">=</span>46, arp <span class="nv">actions</span><span class="o">=</span>NORMAL
</code></pre></td></tr></table>
</div>
</div><h4 id="enable-traffic-forward-use-layer4-data">enable traffic forward use layer4 data</h4>
<p>h2 上起一个服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">h2 python -m SimpleHTTPServer 80 &amp;
</code></pre></td></tr></table>
</div>
</div><p>ovs上增加流表规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ovs-ofctl add-flow s1 arp,action=normal
ovs-ofctl add-flow s1 tcp,tp_dst=80,action=output:2
ovs-ofctl add-flow s1 ip,nw_src=10.0.0.2,action=output:1
</code></pre></td></tr></table>
</div>
</div><p>然后在h1 里面请求</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h1</span> <span class="n">curl</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span><span class="p">:</span><span class="mi">80</span>
<span class="o">&lt;</span><span class="err">!</span><span class="n">DOCTYPE</span> <span class="n">html</span> <span class="n">PUBLIC</span> <span class="s2">&#34;-//W3C//DTD HTML 3.2 Final//EN&#34;</span><span class="o">&gt;&lt;</span><span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Directory</span> <span class="n">listing</span> <span class="k">for</span> <span class="o">/&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="n">Directory</span> <span class="n">listing</span> <span class="k">for</span> <span class="o">/&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">hr</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&#34;.ansible/&#34;</span><span class="o">&gt;.</span><span class="n">ansible</span><span class="o">/&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&#34;.aptitude/&#34;</span><span class="o">&gt;.</span><span class="n">aptitude</span><span class="o">/&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&#34;.bash_history&#34;</span><span class="o">&gt;.</span><span class="n">bash_history</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&#34;.bashrc&#34;</span><span class="o">&gt;.</span><span class="n">bashrc</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&#34;.cache/&#34;</span><span class="o">&gt;.</span><span class="n">cache</span><span class="o">/&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&#34;.config/&#34;</span><span class="o">&gt;.</span><span class="n">config</span><span class="o">/&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&#34;.docker/&#34;</span><span class="o">&gt;.</span><span class="n">docker</span><span class="o">/&lt;/</span><span class="n">a</span><span class="o">&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="match-权重">match 权重</h4>
<p>先加这两条</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-ofctl add-flow s1 <span class="nv">priority</span><span class="o">=</span>400,dl_dst<span class="o">=</span>3a:9e:9d:49:d1:05,action<span class="o">=</span>output:1

root@jiande1-dgw-jiande1:~# ovs-ofctl add-flow s1 <span class="nv">priority</span><span class="o">=</span>400,dl_dst<span class="o">=</span>ca:fe:44:19:9a:22,action<span class="o">=</span>output:2
</code></pre></td></tr></table>
</div>
</div><p>此时可以ping通。再加流表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 ip,priority<span class="o">=</span>500,nw_dst<span class="o">=</span>10.0.0.2,action<span class="o">=</span>drop

ovs-ofctl add-flow s1 arp,action<span class="o">=</span>normal
</code></pre></td></tr></table>
</div>
</div><p>这时就不通了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ovs-ofctl del-flows s1 ip
</code></pre></td></tr></table>
</div>
</div><p>删了这条又通了。</p>
<h3 id="实现路由">实现路由</h3>
<p>ovs通过openflow 实现路由，openflow是通过packet matching来实现的。动作包括:</p>
<ul>
<li>forward到另一port</li>
<li>drop</li>
<li>pass的packet到控制器 controller</li>
</ul>
<p>ovs-ofctl 是看flow table的命令行工具。</p>
<p>ovs可以包含多个flowtable。默认是放在table 0</p>
<p><strong>OpenFlow packet forwarding architecture.</strong></p>
<p><img src="../images/image-20211029150337978.png" alt="image-20211029150337978"></p>
<h4 id="拓扑结构">拓扑结构</h4>
<p><img src="../images/image-20211029151555842.png" alt="image-20211029151555842"></p>
<p><img src="../images/image-20211029151737794.png" alt="image-20211029151737794"></p>
<h4 id="mininet-创建">mininet 创建</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"> mn  --topo linear,2
</code></pre></td></tr></table>
</div>
</div><p>重设ip和网关</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; py h1.setIP<span class="o">(</span><span class="s1">&#39;192.168.1.10/24&#39;</span><span class="o">)</span>
mininet&gt; py h2.setIP<span class="o">(</span><span class="s1">&#39;192.168.2.10/24&#39;</span><span class="o">)</span>
mininet&gt; h1 route add default gw 192.168.1.1
mininet&gt; h2 route add default gw 192.168.2.1
</code></pre></td></tr></table>
</div>
</div><p>mininet dump</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">links</span>
<span class="n">h1</span><span class="o">-</span><span class="n">eth0</span><span class="o">&lt;-&gt;</span><span class="n">s1</span><span class="o">-</span><span class="n">eth1</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">h2</span><span class="o">-</span><span class="n">eth0</span><span class="o">&lt;-&gt;</span><span class="n">s2</span><span class="o">-</span><span class="n">eth1</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">s2</span><span class="o">-</span><span class="n">eth2</span><span class="o">&lt;-&gt;</span><span class="n">s1</span><span class="o">-</span><span class="n">eth2</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">dump</span>
<span class="o">&lt;</span><span class="n">Host</span> <span class="n">h1</span><span class="p">:</span> <span class="n">h1</span><span class="o">-</span><span class="n">eth0</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.10</span> <span class="n">pid</span><span class="o">=</span><span class="mi">41525</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Host</span> <span class="n">h2</span><span class="p">:</span> <span class="n">h2</span><span class="o">-</span><span class="n">eth0</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">2.10</span> <span class="n">pid</span><span class="o">=</span><span class="mi">41527</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">OVSBridge</span> <span class="n">s1</span><span class="p">:</span> <span class="n">lo</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span><span class="n">s1</span><span class="o">-</span><span class="n">eth1</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="n">s1</span><span class="o">-</span><span class="n">eth2</span><span class="p">:</span><span class="bp">None</span> <span class="n">pid</span><span class="o">=</span><span class="mi">41532</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">OVSBridge</span> <span class="n">s2</span><span class="p">:</span> <span class="n">lo</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span><span class="n">s2</span><span class="o">-</span><span class="n">eth1</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="n">s2</span><span class="o">-</span><span class="n">eth2</span><span class="p">:</span><span class="bp">None</span> <span class="n">pid</span><span class="o">=</span><span class="mi">41535</span><span class="o">&gt;</span>
<span class="n">mininet</span><span class="o">&gt;</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">nodes</span>
<span class="n">available</span> <span class="n">nodes</span> <span class="n">are</span><span class="p">:</span>
<span class="n">h1</span> <span class="n">h2</span> <span class="n">s1</span> <span class="n">s2</span>
<span class="n">mininet</span><span class="o">&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="验证路由">验证路由</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h1</span> <span class="n">ip</span> <span class="n">route</span>
<span class="n">default</span> <span class="n">via</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span> <span class="n">dev</span> <span class="n">h1</span><span class="o">-</span><span class="n">eth0</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">dev</span> <span class="n">h1</span><span class="o">-</span><span class="n">eth0</span> <span class="n">proto</span> <span class="n">kernel</span> <span class="n">scope</span> <span class="n">link</span> <span class="n">src</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.10</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h2</span> <span class="n">ip</span> <span class="n">route</span>
<span class="n">default</span> <span class="n">via</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">2.1</span> <span class="n">dev</span> <span class="n">h2</span><span class="o">-</span><span class="n">eth0</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">2.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">dev</span> <span class="n">h2</span><span class="o">-</span><span class="n">eth0</span> <span class="n">proto</span> <span class="n">kernel</span> <span class="n">scope</span> <span class="n">link</span> <span class="n">src</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">2.10</span>

</code></pre></td></tr></table>
</div>
</div><p>查看mac地址，后面要用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ifconfig
h1-eth0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
        inet 192.168.1.10  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::7811:fdff:fe69:6107  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
        ether 7a:11:fd:69:61:07  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets <span class="m">48</span>  bytes <span class="m">3472</span> <span class="o">(</span>3.3 KiB<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">32</span>  bytes <span class="m">2048</span> <span class="o">(</span>2.0 KiB<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>

mininet&gt; h2 ifconfig
h2-eth0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
        inet 192.168.2.10  netmask 255.255.255.0  broadcast 192.168.2.255
        inet6 fe80::d426:8cff:fe70:efd3  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
        ether d6:26:8c:70:ef:d3  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets <span class="m">64</span>  bytes <span class="m">4708</span> <span class="o">(</span>4.5 KiB<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">19</span>  bytes <span class="m">1390</span> <span class="o">(</span>1.3 KiB<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>


root@jiande1-dgw-jiande1:~# ifconfig s1-eth1<span class="p">;</span>ifconfig s2-eth1
s1-eth1: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
        inet6 fe80::4b4:fdff:fe82:ec56  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
        ether 06:b4:fd:82:ec:56  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets <span class="m">27</span>  bytes <span class="m">1698</span> <span class="o">(</span>1.6 KiB<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">44</span>  bytes <span class="m">3276</span> <span class="o">(</span>3.1 KiB<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>

s2-eth1: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
        inet6 fe80::cc99:aaff:fefa:7b9e  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
        ether ce:99:aa:fa:7b:9e  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets <span class="m">18</span>  bytes <span class="m">1320</span> <span class="o">(</span>1.2 KiB<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">59</span>  bytes <span class="m">4414</span> <span class="o">(</span>4.3 KiB<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ifconfig s1-eth2<span class="p">;</span>ifconfig s2-eth2
s1-eth2: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
        inet6 fe80::c451:46ff:fefc:b5e0  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
        ether c6:51:46:fc:b5:e0  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets <span class="m">40</span>  bytes <span class="m">3016</span> <span class="o">(</span>2.9 KiB<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">30</span>  bytes <span class="m">2228</span> <span class="o">(</span>2.1 KiB<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>

s2-eth2: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
        inet6 fe80::246b:6cff:fe41:28d3  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
        ether 26:6b:6c:41:28:d3  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets <span class="m">30</span>  bytes <span class="m">2228</span> <span class="o">(</span>2.1 KiB<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">40</span>  bytes <span class="m">3016</span> <span class="o">(</span>2.9 KiB<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="../images/image-20211102135039456.png" alt="image-20211102135039456"></p>
<p>先把默认的flow删了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl dump-flows s1
</code></pre></td></tr></table>
</div>
</div><p>这个时候h1 不通h2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping 192.168.2.10
PING 192.168.2.10 <span class="o">(</span>192.168.2.10<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
^C
--- 192.168.2.10 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 0ms

mininet&gt;
</code></pre></td></tr></table>
</div>
</div><p>然后分别给s1 s2 配上ip地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ifconfig s1 192.168.1.1/24 up
root@jiande1-dgw-jiande1:~# ifconfig s2 192.168.2.1/24 up
</code></pre></td></tr></table>
</div>
</div><h4 id="配置switch路由">配置switch路由</h4>
<p>给s1配置上arp 流表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 arp,action<span class="o">=</span>normal
</code></pre></td></tr></table>
</div>
</div><p>然后下面配置上下面这条，也就是所有到h1的流量，packet会被 forwarded 到s1-eth1。</p>
<p>mod_dl_dst is responsible for changing the MAC address to the correct MAC address of
host h1 (7a:11:fd:69:61:07).</p>
<p>目的地址是192.168.1.10 的流量，到了s1，把目的mac改为h1 (7a:11:fd:69:61:07)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 ip,nw_dst<span class="o">=</span>192.168.1.10,actions<span class="o">=</span><span class="nv">mod_dl_dst</span><span class="o">=</span>7a:11:fd:69:61:07,output:1
</code></pre></td></tr></table>
</div>
</div><p>目的地址ip为192.168.2.0/24 的流量，到了s1，把src mac改为c6:51:46:fc:b5:e0  (s1-eth2)， 目的mac改为26:6b:6c:41:28:d3 (s2-eth2)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 ip,nw_dst<span class="o">=</span>192.168.2.0/24,actions<span class="o">=</span><span class="nv">mod_dl_src</span><span class="o">=</span>c6:51:46:fc:b5:e0,mod_dl_dst<span class="o">=</span>26:6b:6c:41:28:d3,dec_ttl,output:2
</code></pre></td></tr></table>
</div>
</div><p>s2同理配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s2 arp,action<span class="o">=</span>normal

ovs-ofctl add-flow s2 ip,nw_dst<span class="o">=</span>192.168.2.10,actions<span class="o">=</span><span class="nv">mod_dl_dst</span><span class="o">=</span>d6:26:8c:70:ef:d3,output:1

ovs-ofctl add-flow s2 ip,nw_dst<span class="o">=</span>192.168.1.0/24,actions<span class="o">=</span><span class="nv">mod_dl_src</span><span class="o">=</span>26:6b:6c:41:28:d3,mod_dl_dst<span class="o">=</span>c6:51:46:fc:b5:e0,dec_ttl,output:2
</code></pre></td></tr></table>
</div>
</div><h4 id="验证连通性">验证连通性</h4>
<p>测试，可以通了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping h2
PING 192.168.2.10 <span class="o">(</span>192.168.2.10<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 192.168.2.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>0.066 ms
<span class="m">64</span> bytes from 192.168.2.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>0.079 ms
<span class="m">64</span> bytes from 192.168.2.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>0.079 ms
^C
--- 192.168.2.10 ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2053ms
rtt min/avg/max/mdev <span class="o">=</span> 0.066/0.074/0.079/0.011 ms
mininet&gt;

</code></pre></td></tr></table>
</div>
</div><p>备注一下dump flow：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-ofctl dump-flows s1
NXST_FLOW reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x4<span class="o">)</span>:
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>6815.181s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>6, <span class="nv">n_bytes</span><span class="o">=</span>252, <span class="nv">idle_age</span><span class="o">=</span>6688, arp <span class="nv">actions</span><span class="o">=</span>NORMAL
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>6810.737s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>6, <span class="nv">n_bytes</span><span class="o">=</span>588, <span class="nv">idle_age</span><span class="o">=</span>6692, ip,nw_dst<span class="o">=</span>192.168.1.10 <span class="nv">actions</span><span class="o">=</span>mod_dl_dst:7a:11:fd:69:61:07,output:1
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>6806.313s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>6, <span class="nv">n_bytes</span><span class="o">=</span>588, <span class="nv">idle_age</span><span class="o">=</span>6692, ip,nw_dst<span class="o">=</span>192.168.2.0/24 <span class="nv">actions</span><span class="o">=</span>mod_dl_src:c6:51:46:fc:b5:e0,mod_dl_dst:26:6b:6c:41:28:d3,dec_ttl,output:2

root@jiande1-dgw-jiande1:~# ovs-ofctl dump-flows s2
NXST_FLOW reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x4<span class="o">)</span>:
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>6776.472s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>5, <span class="nv">n_bytes</span><span class="o">=</span>210, <span class="nv">idle_age</span><span class="o">=</span>6693, arp <span class="nv">actions</span><span class="o">=</span>NORMAL
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>6757.161s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>6, <span class="nv">n_bytes</span><span class="o">=</span>588, <span class="nv">idle_age</span><span class="o">=</span>6697, ip,nw_dst<span class="o">=</span>192.168.2.10 <span class="nv">actions</span><span class="o">=</span>mod_dl_dst:d6:26:8c:70:ef:d3,output:1
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>6744.869s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>6, <span class="nv">n_bytes</span><span class="o">=</span>588, <span class="nv">idle_age</span><span class="o">=</span>6697, ip,nw_dst<span class="o">=</span>192.168.1.0/24 <span class="nv">actions</span><span class="o">=</span>mod_dl_src:26:6b:6c:41:28:d3,mod_dl_dst:c6:51:46:fc:b5:e0,dec_ttl,output:2

</code></pre></td></tr></table>
</div>
</div><h4 id="抓包验证">抓包验证</h4>
<p>可以 tcpdump -i s1-eth1</p>
<p>抓s1-eth1的包：</p>
<p><img src="../images/image-20211030094827766.png" alt="image-20211030094827766"></p>
<p>抓s1-eth2上的包，ttl变为63 了，说明多了一跳。</p>
<p><img src="../images/image-20211030094911031.png" alt="image-20211030094911031"></p>
<h4 id="使用ovs-appctl-查看流表详解">使用ovs-appctl 查看流表详解</h4>
<blockquote>
<p>• Input port: 1
• Network layer protocol: IP
• Source IP address: 192.168.1.10
• Destination IP address: 192.168.2.10
• Source MAC address: 7a:11:fd:69:61:07
• Time-to-live (TTL): 64</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-appctl ofproto/trace s1 <span class="nv">in_port</span><span class="o">=</span>1,ip,nw_src<span class="o">=</span>192.168.1.10,nw_dst<span class="o">=</span>192.168.2.10,dl_src<span class="o">=</span>7a:11:fd:69:61:07,nw_ttl<span class="o">=</span><span class="m">64</span>
Bridge: s1
Flow: ip,in_port<span class="o">=</span>1,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>7a:11:fd:69:61:07,dl_dst<span class="o">=</span>00:00:00:00:00:00,nw_src<span class="o">=</span>192.168.1.10,nw_dst<span class="o">=</span>192.168.2.10,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">64</span>

Rule: <span class="nv">table</span><span class="o">=</span><span class="m">0</span> <span class="nv">cookie</span><span class="o">=</span><span class="m">0</span> ip,nw_dst<span class="o">=</span>192.168.2.0/24
OpenFlow <span class="nv">actions</span><span class="o">=</span>mod_dl_src:c6:51:46:fc:b5:e0,mod_dl_dst:26:6b:6c:41:28:d3,dec_ttl,output:2

Final flow: ip,in_port<span class="o">=</span>1,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>c6:51:46:fc:b5:e0,dl_dst<span class="o">=</span>26:6b:6c:41:28:d3,nw_src<span class="o">=</span>192.168.1.10,nw_dst<span class="o">=</span>192.168.2.10,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">63</span>
Megaflow: <span class="nv">recirc_id</span><span class="o">=</span>0,ip,in_port<span class="o">=</span>1,dl_src<span class="o">=</span>7a:11:fd:69:61:07,dl_dst<span class="o">=</span>00:00:00:00:00:00,nw_dst<span class="o">=</span>192.168.2.0/24,nw_ttl<span class="o">=</span>64,nw_frag<span class="o">=</span>no
Datapath actions: set<span class="o">(</span>eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>c6:51:46:fc:b5:e0,dst<span class="o">=</span>26:6b:6c:41:28:d3<span class="o">))</span>,1

</code></pre></td></tr></table>
</div>
</div><h3 id="配置多流表实现路由">配置多流表实现路由</h3>
<h4 id="问题">问题</h4>
<ol>
<li>一张表不够用了</li>
<li>环境变得更加复杂</li>
</ol>
<h4 id="pipeline-processing">pipeline processing</h4>
<p><img src="../images/image-20211102113332674.png" alt="image-20211102113332674"></p>
<p>For any IP packet, the switch is instructed to check the next table (table 1). In
table 1, routing will be placed based on the destination IP address. The source and
destination MACs are modified and Time-To-Live (TTL) is decreased. In table 2, Layer 2
lookup will be placed, and the packet will be forwarded out to the correct port.</p>
<h4 id="拓扑图">拓扑图</h4>
<p><img src="../images/image-20211029151555842.png" alt="image-20211029151555842"></p>
<p>和上一章的拓扑是一样的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; links
h1-eth0&lt;-&gt;s1-eth1 <span class="o">(</span>OK OK<span class="o">)</span>
h2-eth0&lt;-&gt;s2-eth1 <span class="o">(</span>OK OK<span class="o">)</span>
s2-eth2&lt;-&gt;s1-eth2 <span class="o">(</span>OK OK<span class="o">)</span>
mininet&gt; dump
&lt;Host h1: h1-eth0:192.168.1.10 <span class="nv">pid</span><span class="o">=</span>41525&gt;
&lt;Host h2: h2-eth0:192.168.2.10 <span class="nv">pid</span><span class="o">=</span>41527&gt;
&lt;OVSBridge s1: lo:127.0.0.1,s1-eth1:None,s1-eth2:None <span class="nv">pid</span><span class="o">=</span>41532&gt;
&lt;OVSBridge s2: lo:127.0.0.1,s2-eth1:None,s2-eth2:None <span class="nv">pid</span><span class="o">=</span>41535&gt;
mininet&gt;
mininet&gt; nodes
available nodes are:
h1 h2 s1 s2
mininet&gt;
</code></pre></td></tr></table>
</div>
</div><p>增加s1 s2上面的ip 删除掉s1 s2 的flow。</p>
<h4 id="增加流表">增加流表</h4>
<h5 id="table-0---classifier">Table 0 - Classifier</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=0,arp,action=normal&#34;</span>
ovs-ofctl add-flow s1 <span class="s2">&#34;table=0,ip,action=goto_table=1&#34;</span>

ovs-ofctl add-flow s2 <span class="s2">&#34;table=0,arp,action=normal&#34;</span>
ovs-ofctl add-flow s2 <span class="s2">&#34;table=0,ip,action=goto_table=1&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="table-1--layer-3-forwarding">Table 1 – Layer 3 Forwarding</h5>
<p><img src="../images/image-20211102140445209.png" alt="image-20211102140445209"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># switch s1收到所有目的地址是192.168.1.10的报文，修改src mac为s1-eth2 (c6:51:46:fc:b5:e0), dst mac为h1-eth0(7a:11:fd:69:61:07)</span>
ovs-ofctl add-flow s1 <span class="s2">&#34;table=1,ip,nw_dst=192.168.1.10,action=mod_dl_src=c6:51:46:fc:b5:e0,mod_dl_dst=7a:11:fd:69:61:07,dec_ttl,goto_table=2&#34;</span>

<span class="c1"># switch s1 所有目的地址是192.168.2.0/24 的报文，修改src mac为h1-eth0(7a:11:fd:69:61:07), dst mac为s1-eth2(c6:51:46:fc:b5:e0)</span>
ovs-ofctl add-flow s1 <span class="s2">&#34;table=1,ip,nw_dst=192.168.2.0/24,action=mod_dl_src=7a:11:fd:69:61:07,mod_dl_dst=c6:51:46:fc:b5:e0,dec_ttl,goto_table=2&#34;</span>

<span class="c1"># s2 同理设置</span>
ovs-ofctl add-flow s2 <span class="s2">&#34;table=1,ip,nw_dst=192.168.2.10,action=mod_dl_src=26:6b:6c:41:28:d3,mod_dl_dst=d6:26:8c:70:ef:d3,dec_ttl,goto_table=2&#34;</span>

ovs-ofctl add-flow s2 <span class="s2">&#34;table=1,ip,nw_dst=192.168.1.0/24,action=mod_dl_src=d6:26:8c:70:ef:d3,mod_dl_dst=26:6b:6c:41:28:d3,dec_ttl,goto_table=2&#34;</span>

</code></pre></td></tr></table>
</div>
</div><h5 id="table-2--layer-2-forwarding">Table 2 – Layer 2 Forwarding</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=2,dl_dst=7a:11:fd:69:61:07,action=output:1&#34;</span>
ovs-ofctl add-flow s1 <span class="s2">&#34;table=2,dl_dst=c6:51:46:fc:b5:e0,action=output:2&#34;</span>
                      
ovs-ofctl add-flow s2 <span class="s2">&#34;table=2,dl_dst=d6:26:8c:70:ef:d3,action=output:1&#34;</span>
ovs-ofctl add-flow s2 <span class="s2">&#34;table=2,dl_dst=26:6b:6c:41:28:d3,action=output:2&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>这时可以ping 通</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping h2
PING 192.168.2.10 <span class="o">(</span>192.168.2.10<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 192.168.2.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>0.386 ms
<span class="m">64</span> bytes from 192.168.2.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>0.086 ms
^C
--- 192.168.2.10 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1003ms
rtt min/avg/max/mdev <span class="o">=</span> 0.086/0.236/0.386/0.150 ms

</code></pre></td></tr></table>
</div>
</div><h4 id="trace-the-packet-traverses-the-switch">trace the packet traverses the switch</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">• Network layer protocol: IP
• Source IP address: 192.168.1.10
• Destination IP address: 192.168.2.10
• Source MAC address: 7a:11:fd:69:61:07
• Time-to-live (TTL): 64
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-appctl ofproto/trace s1 ip,nw_src<span class="o">=</span>192.168.1.10,nw_dst<span class="o">=</span>192.168.2.10,dl_src<span class="o">=</span>7a:11:fd:69:61:07,nw_ttl<span class="o">=</span><span class="m">64</span>
Bridge: s1
Flow: ip,in_port<span class="o">=</span>ANY,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>7a:11:fd:69:61:07,dl_dst<span class="o">=</span>00:00:00:00:00:00,nw_src<span class="o">=</span>192.168.1.10,nw_dst<span class="o">=</span>192.168.2.10,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">64</span>

Rule: <span class="nv">table</span><span class="o">=</span><span class="m">0</span> <span class="nv">cookie</span><span class="o">=</span><span class="m">0</span> ip
OpenFlow <span class="nv">actions</span><span class="o">=</span>resubmit<span class="o">(</span>,1<span class="o">)</span>

        Resubmitted flow: ip,in_port<span class="o">=</span>ANY,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>7a:11:fd:69:61:07,dl_dst<span class="o">=</span>00:00:00:00:00:00,nw_src<span class="o">=</span>192.168.1.10,nw_dst<span class="o">=</span>192.168.2.10,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">64</span>
        Resubmitted regs: <span class="nv">reg0</span><span class="o">=</span>0x0 <span class="nv">reg1</span><span class="o">=</span>0x0 <span class="nv">reg2</span><span class="o">=</span>0x0 <span class="nv">reg3</span><span class="o">=</span>0x0 <span class="nv">reg4</span><span class="o">=</span>0x0 <span class="nv">reg5</span><span class="o">=</span>0x0 <span class="nv">reg6</span><span class="o">=</span>0x0 <span class="nv">reg7</span><span class="o">=</span>0x0 <span class="nv">reg8</span><span class="o">=</span>0x0 <span class="nv">reg9</span><span class="o">=</span>0x0 <span class="nv">reg10</span><span class="o">=</span>0x0 <span class="nv">reg11</span><span class="o">=</span>0x0 <span class="nv">reg12</span><span class="o">=</span>0x0 <span class="nv">reg13</span><span class="o">=</span>0x0 <span class="nv">reg14</span><span class="o">=</span>0x0 <span class="nv">reg15</span><span class="o">=</span>0x0
        Resubmitted  odp: drop
        Resubmitted megaflow: <span class="nv">recirc_id</span><span class="o">=</span>0,ip,in_port<span class="o">=</span>ANY,nw_dst<span class="o">=</span>192.168.2.0/24,nw_frag<span class="o">=</span>no
        Rule: <span class="nv">table</span><span class="o">=</span><span class="m">1</span> <span class="nv">cookie</span><span class="o">=</span><span class="m">0</span> ip,nw_dst<span class="o">=</span>192.168.2.0/24
        OpenFlow <span class="nv">actions</span><span class="o">=</span>mod_dl_src:7a:11:fd:69:61:07,mod_dl_dst:c6:51:46:fc:b5:e0,dec_ttl,resubmit<span class="o">(</span>,2<span class="o">)</span>

                Resubmitted flow: ip,in_port<span class="o">=</span>ANY,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>7a:11:fd:69:61:07,dl_dst<span class="o">=</span>c6:51:46:fc:b5:e0,nw_src<span class="o">=</span>192.168.1.10,nw_dst<span class="o">=</span>192.168.2.10,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">63</span>
                Resubmitted regs: <span class="nv">reg0</span><span class="o">=</span>0x0 <span class="nv">reg1</span><span class="o">=</span>0x0 <span class="nv">reg2</span><span class="o">=</span>0x0 <span class="nv">reg3</span><span class="o">=</span>0x0 <span class="nv">reg4</span><span class="o">=</span>0x0 <span class="nv">reg5</span><span class="o">=</span>0x0 <span class="nv">reg6</span><span class="o">=</span>0x0 <span class="nv">reg7</span><span class="o">=</span>0x0 <span class="nv">reg8</span><span class="o">=</span>0x0 <span class="nv">reg9</span><span class="o">=</span>0x0 <span class="nv">reg10</span><span class="o">=</span>0x0 <span class="nv">reg11</span><span class="o">=</span>0x0 <span class="nv">reg12</span><span class="o">=</span>0x0 <span class="nv">reg13</span><span class="o">=</span>0x0 <span class="nv">reg14</span><span class="o">=</span>0x0 <span class="nv">reg15</span><span class="o">=</span>0x0
                Resubmitted  odp: drop
                Resubmitted megaflow: <span class="nv">recirc_id</span><span class="o">=</span>0,ip,in_port<span class="o">=</span>ANY,dl_src<span class="o">=</span>7a:11:fd:69:61:07,dl_dst<span class="o">=</span>00:00:00:00:00:00,nw_dst<span class="o">=</span>192.168.2.0/24,nw_ttl<span class="o">=</span>64,nw_frag<span class="o">=</span>no
                Rule: <span class="nv">table</span><span class="o">=</span><span class="m">2</span> <span class="nv">cookie</span><span class="o">=</span><span class="m">0</span> <span class="nv">dl_dst</span><span class="o">=</span>c6:51:46:fc:b5:e0
                OpenFlow <span class="nv">actions</span><span class="o">=</span>output:2

Final flow: ip,in_port<span class="o">=</span>ANY,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>7a:11:fd:69:61:07,dl_dst<span class="o">=</span>c6:51:46:fc:b5:e0,nw_src<span class="o">=</span>192.168.1.10,nw_dst<span class="o">=</span>192.168.2.10,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">63</span>
Megaflow: <span class="nv">recirc_id</span><span class="o">=</span>0,ip,in_port<span class="o">=</span>ANY,dl_src<span class="o">=</span>7a:11:fd:69:61:07,dl_dst<span class="o">=</span>00:00:00:00:00:00,nw_dst<span class="o">=</span>192.168.2.0/24,nw_ttl<span class="o">=</span>64,nw_frag<span class="o">=</span>no
Datapath actions: set<span class="o">(</span>eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>7a:11:fd:69:61:07,dst<span class="o">=</span>c6:51:46:fc:b5:e0<span class="o">))</span>,1

</code></pre></td></tr></table>
</div>
</div><p>Consider the figure above. The first gray box shows the flow fields’ values before the flow
is sent to the switch. Note that if a field is not specified (e.g., dl_dst, or the destination
MAC address), the tool uses the value 0 for that field. The values here match those
specified in the command by the user. The second gray box shows the rules that were
matched in the flow tables. The third gray box shows the final flow fields’ values after the
packet was processed in the switch.</p>
<p><img src="../images/image-20211102141915706.png" alt="image-20211102141915706"></p>
<h3 id="无状态防火墙实现acl">无状态防火墙实现（acl）</h3>
<h4 id="demo">demo</h4>
<p><img src="../images/image-20211103104428542.png" alt="image-20211103104428542"></p>
<p>acl table</p>
<p><img src="../images/image-20211103104440068.png" alt="image-20211103104440068"></p>
<h4 id="拓扑结构-1">拓扑结构</h4>
<p><img src="../images/image-20211103104609167.png" alt="image-20211103104609167"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mn  --topo single,3

mininet&gt; links
h1-eth0&lt;-&gt;s1-eth1 <span class="o">(</span>OK OK<span class="o">)</span>
h2-eth0&lt;-&gt;s1-eth2 <span class="o">(</span>OK OK<span class="o">)</span>
h3-eth0&lt;-&gt;s1-eth3 <span class="o">(</span>OK OK<span class="o">)</span>
mininet&gt; dump
&lt;Host h1: h1-eth0:10.0.0.1 <span class="nv">pid</span><span class="o">=</span>57610&gt;
&lt;Host h2: h2-eth0:10.0.0.2 <span class="nv">pid</span><span class="o">=</span>57612&gt;
&lt;Host h3: h3-eth0:10.0.0.3 <span class="nv">pid</span><span class="o">=</span>57614&gt;
&lt;OVSBridge s1: lo:127.0.0.1,s1-eth1:None,s1-eth2:None,s1-eth3:None <span class="nv">pid</span><span class="o">=</span>57619&gt;
mininet&gt; nodes
available nodes are:
h1 h2 h3 s1
mininet&gt;

mininet&gt; h1 ifconfig   <span class="p">|</span> grep ether
        ether 26:a1:e1:0b:d5:32  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
mininet&gt; h2 ifconfig   <span class="p">|</span> grep ether
        ether ca:cc:e2:86:6a:76  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
mininet&gt; h3 ifconfig   <span class="p">|</span> grep ether
        ether 06:b2:83:3f:9b:2a  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>


</code></pre></td></tr></table>
</div>
</div><p>先删除s1 流表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ovs-ofctl del-flows s1
</code></pre></td></tr></table>
</div>
</div><p>配置s1上的acl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=0,priority=40000,ip,nw_src=10.0.0.3,nw_dst=10.0.0.1,action=drop&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>ovs 让到表0的走到表1 这个权重是默认的32768</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=0,action=goto_table=1&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>设置基本的 layer 2/layer 3 包处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ovs-ofctl add-flow s1 &#34;table=1,action=normal&#34;
</code></pre></td></tr></table>
</div>
</div><p>验证：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping h2
PING 10.0.0.2 <span class="o">(</span>10.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.505 ms
^C
--- 10.0.0.2 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">1</span> received, 0% packet loss, <span class="nb">time</span> 0ms
rtt min/avg/max/mdev <span class="o">=</span> 0.505/0.505/0.505/0.000 ms
mininet&gt; h1 ping h3
PING 10.0.0.3 <span class="o">(</span>10.0.0.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
^C
--- 10.0.0.3 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 1008ms

mininet&gt; h2 ping h3
PING 10.0.0.3 <span class="o">(</span>10.0.0.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.547 ms
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.050 ms
^C
--- 10.0.0.3 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1022ms
rtt min/avg/max/mdev <span class="o">=</span> 0.050/0.298/0.547/0.249 ms
mininet&gt;

</code></pre></td></tr></table>
</div>
</div><p>可见h1 到 h3 不通 符合预期。</p>
<h4 id="dump流表看看">dump流表看看</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-ofctl dump-flows s1
NXST_FLOW reply <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x4<span class="o">)</span>:
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>24.096s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>2, <span class="nv">n_bytes</span><span class="o">=</span>196, <span class="nv">idle_age</span><span class="o">=</span>7, <span class="nv">priority</span><span class="o">=</span>40000,ip,nw_src<span class="o">=</span>10.0.0.3,nw_dst<span class="o">=</span>10.0.0.1 <span class="nv">actions</span><span class="o">=</span>drop
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>20.665s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>18, <span class="nv">n_bytes</span><span class="o">=</span>1316, <span class="nv">idle_age</span><span class="o">=</span>4, <span class="nv">actions</span><span class="o">=</span>resubmit<span class="o">(</span>,1<span class="o">)</span>
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>17.001s, <span class="nv">table</span><span class="o">=</span>1, <span class="nv">n_packets</span><span class="o">=</span>18, <span class="nv">n_bytes</span><span class="o">=</span>1316, <span class="nv">idle_age</span><span class="o">=</span>4, <span class="nv">actions</span><span class="o">=</span>NORMAL

</code></pre></td></tr></table>
</div>
</div><h4 id="使用ovs-appctl-分析">使用ovs-appctl 分析</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">• Network layer protocol: IP
• Source IP address: 10.0.0.1
• Destination IP address: 10.0.0.3
• Source MAC address: 26:a1:e1:0b:d5:32
• Destination MAC address: 06:b2:83:3f:9b:2a
</code></pre></td></tr></table>
</div>
</div><p>命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-appctl ofproto/trace s1 ip,nw_src<span class="o">=</span>10.0.0.1,nw_dst<span class="o">=</span>10.0.0.3,dl_src<span class="o">=</span>26:a1:e1:0b:d5:32,dl_dst<span class="o">=</span>06:b2:83:3f:9b:2a
</code></pre></td></tr></table>
</div>
</div><p>可以看到  h1 到h3 是正常通的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-appctl ofproto/trace s1 ip,nw_src<span class="o">=</span>10.0.0.1,nw_dst<span class="o">=</span>10.0.0.3,dl_src<span class="o">=</span>26:a1:e1:0b:d5:32,dl_dst<span class="o">=</span>06:b2:83:3f:9b:2a
Bridge: s1
Flow: ip,in_port<span class="o">=</span>ANY,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>26:a1:e1:0b:d5:32,dl_dst<span class="o">=</span>06:b2:83:3f:9b:2a,nw_src<span class="o">=</span>10.0.0.1,nw_dst<span class="o">=</span>10.0.0.3,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">0</span>

Rule: <span class="nv">table</span><span class="o">=</span><span class="m">0</span> <span class="nv">cookie</span><span class="o">=</span><span class="m">0</span>
OpenFlow <span class="nv">actions</span><span class="o">=</span>resubmit<span class="o">(</span>,1<span class="o">)</span>

        Resubmitted flow: ip,in_port<span class="o">=</span>ANY,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>26:a1:e1:0b:d5:32,dl_dst<span class="o">=</span>06:b2:83:3f:9b:2a,nw_src<span class="o">=</span>10.0.0.1,nw_dst<span class="o">=</span>10.0.0.3,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">0</span>
        Resubmitted regs: <span class="nv">reg0</span><span class="o">=</span>0x0 <span class="nv">reg1</span><span class="o">=</span>0x0 <span class="nv">reg2</span><span class="o">=</span>0x0 <span class="nv">reg3</span><span class="o">=</span>0x0 <span class="nv">reg4</span><span class="o">=</span>0x0 <span class="nv">reg5</span><span class="o">=</span>0x0 <span class="nv">reg6</span><span class="o">=</span>0x0 <span class="nv">reg7</span><span class="o">=</span>0x0 <span class="nv">reg8</span><span class="o">=</span>0x0 <span class="nv">reg9</span><span class="o">=</span>0x0 <span class="nv">reg10</span><span class="o">=</span>0x0 <span class="nv">reg11</span><span class="o">=</span>0x0 <span class="nv">reg12</span><span class="o">=</span>0x0 <span class="nv">reg13</span><span class="o">=</span>0x0 <span class="nv">reg14</span><span class="o">=</span>0x0 <span class="nv">reg15</span><span class="o">=</span>0x0
        Resubmitted  odp: drop
        Resubmitted megaflow: <span class="nv">recirc_id</span><span class="o">=</span>0,ip,in_port<span class="o">=</span>ANY,nw_dst<span class="o">=</span>10.0.0.2/31,nw_frag<span class="o">=</span>no
        Rule: <span class="nv">table</span><span class="o">=</span><span class="m">1</span> <span class="nv">cookie</span><span class="o">=</span><span class="m">0</span>
        OpenFlow <span class="nv">actions</span><span class="o">=</span>NORMAL
        no learned MAC <span class="k">for</span> destination, flooding

Final flow: unchanged
Megaflow: <span class="nv">recirc_id</span><span class="o">=</span>0,ip,in_port<span class="o">=</span>ANY,vlan_tci<span class="o">=</span>0x0000/0x1fff,dl_src<span class="o">=</span>26:a1:e1:0b:d5:32,dl_dst<span class="o">=</span>06:b2:83:3f:9b:2a,nw_dst<span class="o">=</span>10.0.0.2/31,nw_frag<span class="o">=</span>no
Datapath actions: 1,4,3,2

</code></pre></td></tr></table>
</div>
</div><p>再看看回的流量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-appctl ofproto/trace s1 ip,nw_dst<span class="o">=</span>10.0.0.1,nw_src<span class="o">=</span>10.0.0.3,dl_dst<span class="o">=</span>26:a1:e1:0b:d5:32,dl_src<span class="o">=</span>06:b2:83:3f:9b:2a

<span class="c1"># 这边也可以用</span>
ovs-appctl ofproto/trace s1 ip,nw_dst<span class="o">=</span>10.0.0.1,nw_src<span class="o">=</span>10.0.0.3
</code></pre></td></tr></table>
</div>
</div><p>就被drop了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# ovs-appctl ofproto/trace s1 ip,nw_dst<span class="o">=</span>10.0.0.1,nw_src<span class="o">=</span>10.0.0.3,dl_dst<span class="o">=</span>26:a1:e1:0b:d5:32,dl_src<span class="o">=</span>06:b2:83:3f:9b:2a
Bridge: s1
Flow: ip,in_port<span class="o">=</span>ANY,vlan_tci<span class="o">=</span>0x0000,dl_src<span class="o">=</span>06:b2:83:3f:9b:2a,dl_dst<span class="o">=</span>26:a1:e1:0b:d5:32,nw_src<span class="o">=</span>10.0.0.3,nw_dst<span class="o">=</span>10.0.0.1,nw_proto<span class="o">=</span>0,nw_tos<span class="o">=</span>0,nw_ecn<span class="o">=</span>0,nw_ttl<span class="o">=</span><span class="m">0</span>

Rule: <span class="nv">table</span><span class="o">=</span><span class="m">0</span> <span class="nv">cookie</span><span class="o">=</span><span class="m">0</span> <span class="nv">priority</span><span class="o">=</span>40000,ip,nw_src<span class="o">=</span>10.0.0.3,nw_dst<span class="o">=</span>10.0.0.1
OpenFlow <span class="nv">actions</span><span class="o">=</span>drop

Final flow: unchanged
Megaflow: <span class="nv">recirc_id</span><span class="o">=</span>0,ip,in_port<span class="o">=</span>ANY,nw_src<span class="o">=</span>10.0.0.3,nw_dst<span class="o">=</span>10.0.0.1,nw_frag<span class="o">=</span>no
Datapath actions: drop
root@jiande1-dgw-jiande1:~#

</code></pre></td></tr></table>
</div>
</div><h3 id="有状态防火墙实现-通过connection-tracking-conntrack">有状态防火墙实现-通过Connection Tracking (conntrack)</h3>
<p>无状态防火墙的优点：快速 （只基于ip 端口 协议）</p>
<p>有状态：能够更好的保护dos 攻击 ，IP Spoofing 攻击等</p>
<p>Conntrack 保存信息： (TCP/UDP/ICMP) 保存到一个状态表，包括</p>
<ul>
<li>IP addresses</li>
<li>port number pairs</li>
<li>protocol types</li>
<li>state</li>
<li>timeout</li>
</ul>
<h4 id="拓扑">拓扑</h4>
<p><img src="../images/image-20211103113245191.png" alt="image-20211103113245191"></p>
<p>和上一章一样</p>
<h4 id="配置">配置</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># table 0 基本的 l2 l3 权重32768</span>
ovs-ofctl add-flow s1 <span class="s2">&#34;table=0,action=normal&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>The ct_state parameter refers to the state of the conntrack.</p>
<p><code>-trk</code> h1 如果有包发往 h3，ct会开始跟踪报文。 switch 会继续查表1 。这条流表权重设置为 40000</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=0,priority=40000,ip,nw_src=10.0.0.1,nw_dst=10.0.0.3,ct_state=-trk,action=ct(table=1)&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>下面这条同理，h3 到h1 的也被连接跟踪</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=0,priority=40000,ip,nw_src=10.0.0.3,nw_dst=10.0.0.1,ct_state=-trk,action=ct(table=1)&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>下面设置表1 。 这条的意思是，如果h1 发往h3 ，switch s1会重定向流量到  port 3, (s1-eth3)。任何host 产生新的包，都会被认为是新的流量。<code>commit </code>参数 是让conntrack 模块记录相关信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=1,ip,nw_src=10.0.0.1,nw_dst=10.0.0.3,ct_state=+trk+new,action=ct(commit),3&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>如果h1 发送回包信息到h3，switch s1会重定向流量到 port 3, (s1-eth3)。任何回包的流量，会被标记为<code>est</code> （established）。 这边可以看到，ct针对新建连接和已建立连接处理是不同的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=1,ip,nw_src=10.0.0.1,nw_dst=10.0.0.3,ct_state=+trk+est,action=output:3&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>下面这条意思是，如果是h3 到h1 的流量，那么 switch s1 会drop流量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=1,ip,nw_src=10.0.0.3,nw_dst=10.0.0.1,ct_state=+trk+new,action=drop&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>如果h3 回 h1 的流量，switch s1 会 转发到port 1, (s1-eth1).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 <span class="s2">&#34;table=1,ip,nw_src=10.0.0.3,nw_dst=10.0.0.1,ct_state=+trk+est,action=output:1&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="验证">验证</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping h3
PING 10.0.0.3 <span class="o">(</span>10.0.0.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.376 ms
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.260 ms
^C
--- 10.0.0.3 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1024ms
rtt min/avg/max/mdev <span class="o">=</span> 0.260/0.318/0.376/0.058 ms
mininet&gt; h3  ping h1
PING 10.0.0.1 <span class="o">(</span>10.0.0.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
^C
--- 10.0.0.1 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 0ms

mininet&gt;
mininet&gt;
mininet&gt; h3  ping h2
PING 10.0.0.2 <span class="o">(</span>10.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.362 ms
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.066 ms
^C
--- 10.0.0.2 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1015ms
rtt min/avg/max/mdev <span class="o">=</span> 0.066/0.214/0.362/0.148 ms
mininet&gt;

</code></pre></td></tr></table>
</div>
</div><p>实现了 h1 ping h3 可以通，h3 ping h1 就不通了。</p>
<h4 id="monitoring-conntrack-state-table">Monitoring conntrack state table</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">mininet&gt; h3 bash
root@jiande1-dgw-jiande1:~# nohup iperf -s &amp;
[1] 32865

mininet&gt; h1 iperf -c 10.0.0.3 -i 2 -t 600
------------------------------------------------------------
Client connecting to 10.0.0.3, TCP port 5001
TCP window size: 85.3 KByte (default)
------------------------------------------------------------
[  3] local 10.0.0.1 port 50954 connected with 10.0.0.3 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0- 2.0 sec  7.24 GBytes  31.1 Gbits/sec
[  3]  2.0- 4.0 sec  4.51 GBytes  19.4 Gbits/sec
[  3]  4.0- 6.0 sec  7.01 GBytes  30.1 Gbits/sec
[  3]  6.0- 8.0 sec  6.33 GBytes  27.2 Gbits/sec
[  3]  8.0-10.0 sec  4.75 GBytes  20.4 Gbits/sec
[  3] 10.0-12.0 sec  3.95 GBytes  17.0 Gbits/sec

</code></pre></td></tr></table>
</div>
</div><p>节点上dump</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~#  ovs-dpctl dump-conntrack <span class="p">|</span> grep 10.0.0.1
tcp,orig<span class="o">=(</span><span class="nv">src</span><span class="o">=</span>10.0.0.1,dst<span class="o">=</span>10.0.0.3,sport<span class="o">=</span>50954,dport<span class="o">=</span>5001<span class="o">)</span>,reply<span class="o">=(</span><span class="nv">src</span><span class="o">=</span>10.0.0.3,dst<span class="o">=</span>10.0.0.1,sport<span class="o">=</span>5001,dport<span class="o">=</span>50954<span class="o">)</span>,protoinfo<span class="o">=(</span><span class="nv">state</span><span class="o">=</span>ESTABLISHED<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>节点上使用 conntrack 看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~# conntrack -E <span class="p">|</span> grep 10.0.0.1
    <span class="o">[</span>NEW<span class="o">]</span> tcp      <span class="m">6</span> <span class="m">120</span> SYN_SENT <span class="nv">src</span><span class="o">=</span>10.0.0.1 <span class="nv">dst</span><span class="o">=</span>10.0.0.3 <span class="nv">sport</span><span class="o">=</span><span class="m">50986</span> <span class="nv">dport</span><span class="o">=</span><span class="m">5001</span> <span class="o">[</span>UNREPLIED<span class="o">]</span> <span class="nv">src</span><span class="o">=</span>10.0.0.3 <span class="nv">dst</span><span class="o">=</span>10.0.0.1 <span class="nv">sport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">dport</span><span class="o">=</span><span class="m">50986</span>
 <span class="o">[</span>UPDATE<span class="o">]</span> tcp      <span class="m">6</span> <span class="m">60</span> SYN_RECV <span class="nv">src</span><span class="o">=</span>10.0.0.1 <span class="nv">dst</span><span class="o">=</span>10.0.0.3 <span class="nv">sport</span><span class="o">=</span><span class="m">50986</span> <span class="nv">dport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">src</span><span class="o">=</span>10.0.0.3 <span class="nv">dst</span><span class="o">=</span>10.0.0.1 <span class="nv">sport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">dport</span><span class="o">=</span><span class="m">50986</span>
 <span class="o">[</span>UPDATE<span class="o">]</span> tcp      <span class="m">6</span> <span class="m">432000</span> ESTABLISHED <span class="nv">src</span><span class="o">=</span>10.0.0.1 <span class="nv">dst</span><span class="o">=</span>10.0.0.3 <span class="nv">sport</span><span class="o">=</span><span class="m">50986</span> <span class="nv">dport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">src</span><span class="o">=</span>10.0.0.3 <span class="nv">dst</span><span class="o">=</span>10.0.0.1 <span class="nv">sport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">dport</span><span class="o">=</span><span class="m">50986</span> <span class="o">[</span>ASSURED<span class="o">]</span>
 <span class="o">[</span>UPDATE<span class="o">]</span> tcp      <span class="m">6</span> <span class="m">120</span> FIN_WAIT <span class="nv">src</span><span class="o">=</span>10.0.0.1 <span class="nv">dst</span><span class="o">=</span>10.0.0.3 <span class="nv">sport</span><span class="o">=</span><span class="m">50986</span> <span class="nv">dport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">src</span><span class="o">=</span>10.0.0.3 <span class="nv">dst</span><span class="o">=</span>10.0.0.1 <span class="nv">sport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">dport</span><span class="o">=</span><span class="m">50986</span> <span class="o">[</span>ASSURED<span class="o">]</span>
 <span class="o">[</span>UPDATE<span class="o">]</span> tcp      <span class="m">6</span> <span class="m">30</span> LAST_ACK <span class="nv">src</span><span class="o">=</span>10.0.0.1 <span class="nv">dst</span><span class="o">=</span>10.0.0.3 <span class="nv">sport</span><span class="o">=</span><span class="m">50986</span> <span class="nv">dport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">src</span><span class="o">=</span>10.0.0.3 <span class="nv">dst</span><span class="o">=</span>10.0.0.1 <span class="nv">sport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">dport</span><span class="o">=</span><span class="m">50986</span> <span class="o">[</span>ASSURED<span class="o">]</span>
 <span class="o">[</span>UPDATE<span class="o">]</span> tcp      <span class="m">6</span> <span class="m">120</span> TIME_WAIT <span class="nv">src</span><span class="o">=</span>10.0.0.1 <span class="nv">dst</span><span class="o">=</span>10.0.0.3 <span class="nv">sport</span><span class="o">=</span><span class="m">50986</span> <span class="nv">dport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">src</span><span class="o">=</span>10.0.0.3 <span class="nv">dst</span><span class="o">=</span>10.0.0.1 <span class="nv">sport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">dport</span><span class="o">=</span><span class="m">50986</span> <span class="o">[</span>ASSURED<span class="o">]</span>
 <span class="o">[</span>DESTROY<span class="o">]</span> tcp      <span class="m">6</span> <span class="nv">src</span><span class="o">=</span>10.0.0.1 <span class="nv">dst</span><span class="o">=</span>10.0.0.3 <span class="nv">sport</span><span class="o">=</span><span class="m">50978</span> <span class="nv">dport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">src</span><span class="o">=</span>10.0.0.3 <span class="nv">dst</span><span class="o">=</span>10.0.0.1 <span class="nv">sport</span><span class="o">=</span><span class="m">5001</span> <span class="nv">dport</span><span class="o">=</span><span class="m">50978</span> <span class="o">[</span>ASSURED<span class="o">]</span>

</code></pre></td></tr></table>
</div>
</div><p>这个时候再看，session is completed，state 变为TIME_WAIT（ending of a  TCP session）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@jiande1-dgw-jiande1:~#  ovs-dpctl dump-conntrack <span class="p">|</span> grep 10.0.0.1
tcp,orig<span class="o">=(</span><span class="nv">src</span><span class="o">=</span>10.0.0.1,dst<span class="o">=</span>10.0.0.3,sport<span class="o">=</span>50986,dport<span class="o">=</span>5001<span class="o">)</span>,reply<span class="o">=(</span><span class="nv">src</span><span class="o">=</span>10.0.0.3,dst<span class="o">=</span>10.0.0.1,sport<span class="o">=</span>5001,dport<span class="o">=</span>50986<span class="o">)</span>,protoinfo<span class="o">=(</span><span class="nv">state</span><span class="o">=</span>TIME_WAIT<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="qos实现">qos实现</h3>
<h4 id="hierarchical-token-tucket-htb-算法">Hierarchical token tucket (HTB) 算法</h4>
<p><img src="../images/image-20211104134902466.png" alt="image-20211104134902466"></p>
<h4 id="qos-整形-shaping--and--管制policing">QoS 整形 （shaping ） and  管制（policing）</h4>
<p><img src="../images/image-20211104134856658.png" alt="image-20211104134856658"></p>
<p>Policing用于控制接口上接收分组（ingress）的速率，是一种简单的QoS的功能，通过简单的丢包机制实现接口速率的限制，它既可以作用于物理接口，也可以作用于虚拟接口；</p>
<p>Shaping是作用于接口上的出口流量（egress）策略，可以实现多个QoS队列，不同队列里面处理不同策略；</p>
<p>shaping用于实现出口流量的控制，使用了队列queue，可以缓存和调度数据包发送顺序，比policing更加精确和有效，在OVS的数据表中主要使用QoS和Queue两张表。</p>
<p>OVS自身并不实现QoS功能，QoS功能的实现是在linux内核中，OVS只是能够配置部分OVS支持的QoS类型。如果需要一些OVS不支持的QoS类型，可以通过patch来支持这些配置，也可以通过传统的TC工具直接进行QoS的策略配置。</p>
<h4 id="qos-metering">QoS metering</h4>
<p>• Green: Traffic rate is below the CIR and is in-contract.
• Yellow: Traffic rate falls between CIR and PIR and is out-of-contract.
• Red: Traffic is above PIR and is out-of-contract.</p>
<p>Though Open vSwitch supports three color marking, our version of Open vSwitch only
supports two color marking (green and red).</p>
<p>详细解释看这一片： <a href="https://cshihong.github.io/2018/02/07/%E6%B5%81%E9%87%8F%E7%9B%91%E7%AE%A1%E5%92%8C%E6%B5%81%E9%87%8F%E6%95%B4%E5%BD%A2/">https://cshihong.github.io/2018/02/07/%E6%B5%81%E9%87%8F%E7%9B%91%E7%AE%A1%E5%92%8C%E6%B5%81%E9%87%8F%E6%95%B4%E5%BD%A2/</a></p>
<p>Traffic shaping and policing 详细讨论： <a href="https://blog.51cto.com/bbxiongmous/402233">https://blog.51cto.com/bbxiongmous/402233</a></p>
<p>Consider Figure 3. The topology consists of two switches and four end-hosts. Hosts h2 and
h4 are acting as FTP and HTTP servers, whereas hosts h1 and h3 are competing clients.</p>
<p><img src="../images/image-20211104135208529.png" alt="image-20211104135208529"></p>
<p>这边mininet使用自定义模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">mininet.topo</span> <span class="kn">import</span> <span class="n">Topo</span>

<span class="k">class</span> <span class="nc">MyTopo</span><span class="p">(</span> <span class="n">Topo</span> <span class="p">):</span>
    <span class="s2">&#34;Simple topology example.&#34;</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="s2">&#34;Create custom topo.&#34;</span>

        <span class="c1"># Add hosts and switches</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h1&#39;</span> <span class="p">)</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h2&#39;</span> <span class="p">)</span>
        <span class="n">h3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h3&#39;</span> <span class="p">)</span>
        <span class="n">h4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h4&#39;</span> <span class="p">)</span>

        <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span> <span class="s1">&#39;s1&#39;</span> <span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span> <span class="s1">&#39;s2&#39;</span> <span class="p">)</span>

        <span class="c1"># Add links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h1</span><span class="p">,</span> <span class="n">s1</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h3</span><span class="p">,</span> <span class="n">s1</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h2</span><span class="p">,</span> <span class="n">s2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h4</span><span class="p">,</span> <span class="n">s2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="p">)</span>


<span class="n">topos</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;mytopo&#39;</span><span class="p">:</span> <span class="p">(</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">MyTopo</span><span class="p">()</span> <span class="p">)</span> <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>测试一下基本连通性，可见是ok的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mn --custom topo-qos.py  --topo mytopo --test pingall

root@jiande1-dgw-jiande1:~# mn --custom topo-qos.py  --topo mytopo --test pingall
*** No default OpenFlow controller found <span class="k">for</span> default switch!
*** Falling back to OVS Bridge
*** Creating network
*** Adding controller
*** Adding hosts:
h1 h2 h3 h4
*** Adding switches:
s1 s2
*** Adding links:
<span class="o">(</span>h1, s1<span class="o">)</span> <span class="o">(</span>h2, s2<span class="o">)</span> <span class="o">(</span>h3, s1<span class="o">)</span> <span class="o">(</span>h4, s2<span class="o">)</span> <span class="o">(</span>s1, s2<span class="o">)</span>
*** Configuring hosts
h1 h2 h3 h4
*** Starting controller

*** Starting <span class="m">2</span> switches
s1 s2 ...
*** Waiting <span class="k">for</span> switches to connect
s1 s2
*** Ping: testing ping reachability
h1 -&gt; h2 h3 h4
h2 -&gt; h1 h3 h4
h3 -&gt; h1 h2 h4
h4 -&gt; h1 h2 h3
*** Results: 0% dropped <span class="o">(</span>12/12 received<span class="o">)</span>
*** Stopping <span class="m">0</span> controllers

*** Stopping <span class="m">5</span> links
.....
*** Stopping <span class="m">2</span> switches
s1 s2
*** Stopping <span class="m">4</span> hosts
h1 h2 h3 h4
*** Done


mininet&gt; links
h1-eth0&lt;-&gt;s1-eth1 <span class="o">(</span>OK OK<span class="o">)</span>
h2-eth0&lt;-&gt;s2-eth1 <span class="o">(</span>OK OK<span class="o">)</span>
h3-eth0&lt;-&gt;s1-eth2 <span class="o">(</span>OK OK<span class="o">)</span>
h4-eth0&lt;-&gt;s2-eth2 <span class="o">(</span>OK OK<span class="o">)</span>
s1-eth3&lt;-&gt;s2-eth3 <span class="o">(</span>OK OK<span class="o">)</span>
mininet&gt; dump
&lt;Host h1: h1-eth0:10.0.0.1 <span class="nv">pid</span><span class="o">=</span>12717&gt;
&lt;Host h2: h2-eth0:10.0.0.2 <span class="nv">pid</span><span class="o">=</span>12719&gt;
&lt;Host h3: h3-eth0:10.0.0.3 <span class="nv">pid</span><span class="o">=</span>12721&gt;
&lt;Host h4: h4-eth0:10.0.0.4 <span class="nv">pid</span><span class="o">=</span>12723&gt;
&lt;OVSBridge s1: lo:127.0.0.1,s1-eth1:None,s1-eth2:None,s1-eth3:None <span class="nv">pid</span><span class="o">=</span>12728&gt;
&lt;OVSBridge s2: lo:127.0.0.1,s2-eth1:None,s2-eth2:None,s2-eth3:None <span class="nv">pid</span><span class="o">=</span>12731&gt;

</code></pre></td></tr></table>
</div>
</div><h4 id="没有加qos的时候带宽">没有加qos的时候带宽</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h2 nohup iperf -s -p <span class="m">21</span> <span class="p">&amp;</span>
nohup: appending output to <span class="s1">&#39;nohup.out&#39;</span>

mininet&gt; h1 iperf -c 10.0.0.2 -i <span class="m">2</span>  -p <span class="m">21</span>
------------------------------------------------------------
Client connecting to 10.0.0.2, TCP port <span class="m">21</span>
TCP window size: 85.3 KByte <span class="o">(</span>default<span class="o">)</span>
------------------------------------------------------------
<span class="o">[</span>  3<span class="o">]</span> <span class="nb">local</span> 10.0.0.1 port <span class="m">33936</span> connected with 10.0.0.2 port <span class="m">21</span>
<span class="o">[</span> ID<span class="o">]</span> Interval       Transfer     Bandwidth
<span class="o">[</span>  3<span class="o">]</span>  0.0- 2.0 sec  7.71 GBytes  33.1 Gbits/sec
<span class="o">[</span>  3<span class="o">]</span>  2.0- 4.0 sec  7.69 GBytes  33.0 Gbits/sec
<span class="o">[</span>  3<span class="o">]</span>  4.0- 6.0 sec  7.86 GBytes  33.8 Gbits/sec
^C<span class="o">[</span>  3<span class="o">]</span>  0.0- 6.0 sec  23.3 GBytes  33.3 Gbits/sec
mininet&gt;
</code></pre></td></tr></table>
</div>
</div><h4 id="配置qos-policing">配置qos Policing</h4>
<p>在s1上配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl <span class="nb">set</span> interface s1-eth1 <span class="nv">ingress_policing_rate</span><span class="o">=</span><span class="m">10000</span>
</code></pre></td></tr></table>
</div>
</div><p>再次测试，就只有10M左右</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 iperf -c 10.0.0.2 -i <span class="m">2</span>  -p <span class="m">21</span>
------------------------------------------------------------
Client connecting to 10.0.0.2, TCP port <span class="m">21</span>
TCP window size: 85.3 KByte <span class="o">(</span>default<span class="o">)</span>
------------------------------------------------------------
<span class="o">[</span>  3<span class="o">]</span> <span class="nb">local</span> 10.0.0.1 port <span class="m">33950</span> connected with 10.0.0.2 port <span class="m">21</span>
<span class="o">[</span> ID<span class="o">]</span> Interval       Transfer     Bandwidth
<span class="o">[</span>  3<span class="o">]</span>  0.0- 2.0 sec  4.25 MBytes  17.8 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span>  2.0- 4.0 sec  2.00 MBytes  8.39 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span>  4.0- 6.0 sec  2.75 MBytes  11.5 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span>  6.0- 8.0 sec  2.25 MBytes  9.44 Mbits/sec
^C<span class="o">[</span>  3<span class="o">]</span>  0.0- 9.5 sec  12.8 MBytes  11.2 Mbits/sec
</code></pre></td></tr></table>
</div>
</div><p>清理qos</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl <span class="nb">set</span> interface s1-eth1 <span class="nv">ingress_policing_rate</span><span class="o">=</span><span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><p>可以使用这个命令查看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl list interface s1-eth1 <span class="p">|</span> grep  ingress_policing_rate 
</code></pre></td></tr></table>
</div>
</div><p>**ingress_policing_rate：**为接口最大收包速率，单位kbps，超过该速度的报文将被丢弃，默认值为0表示关闭该功能；
**ingress_policing_burst：**为最大突发流量大小，单位kb。默认值0表示1000kb，这个参数最小值应不小于接口的MTU，通常设置为ingress_policing_rate的10%更有利于tcp实现全速率；</p>
<h4 id="配置-single-rate-two-colors-traffic-policing-in-switch-s1">配置 Single-Rate Two-Colors Traffic Policing in switch s1</h4>
<p>这边要保证ovs 版本大于2.10。我是升级了ubuntu到 20.04上去再装的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~# dpkg -l <span class="p">|</span> grep openvswitch
ii  openvswitch-common                     2.13.3-0ubuntu0.20.04.2           amd64        Open vSwitch common components
ii  openvswitch-switch                     2.13.3-0ubuntu0.20.04.2           amd64        Open vSwitch switch implementations
ii  python3-openvswitch                    2.13.3-0ubuntu0.20.04.2           all          Python <span class="m">3</span> bindings <span class="k">for</span> Open vSwitch
root@testovs:~#

</code></pre></td></tr></table>
</div>
</div><p>验证， band_types: drop 为支持 single rate two colors metering。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~# ovs-ofctl -O OpenFlow15 meter-features s1
OFPST_METER_FEATURES reply <span class="o">(</span>OF1.5<span class="o">)</span> <span class="o">(</span><span class="nv">xid</span><span class="o">=</span>0x2<span class="o">)</span>:
max_meter:4294967295 max_bands:1 max_color:0
band_types: drop
capabilities: kbps pktps burst stats
root@testovs:~#
</code></pre></td></tr></table>
</div>
</div><p>新增s1 meter，  rate limit 300 Mbps。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl -O OpenFlow15 add-meter s1  <span class="nv">meter</span><span class="o">=</span>1,kbps,band<span class="o">=</span><span class="nv">type</span><span class="o">=</span>drop,rate<span class="o">=</span><span class="m">300000</span>
</code></pre></td></tr></table>
</div>
</div><p>把meter 装到 s1 上，这个flow 匹配 tcp dst port 21，output端口为 s1-eth3。这是s1会限速到300 Mbps</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl -O OpenFlow15 add-flow s1 tcp,tp_dst<span class="o">=</span>21,actions<span class="o">=</span>meter:1,output:3
</code></pre></td></tr></table>
</div>
</div><p>再增加一条</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl -O OpenFlow15 add-flow s1 tcp,tp_dst<span class="o">=</span>80,actions<span class="o">=</span>meter:1,output:3
</code></pre></td></tr></table>
</div>
</div><p>80 和21 端口的这两条，都会使用相同的meter 速率，即300 Mbps</p>
<h4 id="验证-1">验证</h4>
<p>h4 启动服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h4 nohup iperf -s -p <span class="m">80</span> <span class="p">&amp;</span>
</code></pre></td></tr></table>
</div>
</div><p>暂时先留空</p>
<h4 id="qos-shaping-in-switch-s1">QoS shaping in switch s1</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl -- <span class="nb">set</span> port s1-eth3 <span class="se">\
</span><span class="se"></span><span class="nv">qos</span><span class="o">=</span>@newqos -- --id<span class="o">=</span>@newqos <span class="se">\
</span><span class="se"></span>create qos <span class="nv">type</span><span class="o">=</span>linux-htb other-config:max-rate<span class="o">=</span><span class="m">100000000</span> <span class="se">\
</span><span class="se"></span><span class="nv">queues</span><span class="o">=</span><span class="nv">1</span><span class="o">=</span>@q1,2<span class="o">=</span>@q2 <span class="se">\
</span><span class="se"></span>-- --id<span class="o">=</span>@q1 create queue other-config:min-rate<span class="o">=</span><span class="m">70000000</span> <span class="se">\
</span><span class="se"></span>-- --id<span class="o">=</span>@q2 create queue other-config:min-rate<span class="o">=</span><span class="m">30000000</span>
</code></pre></td></tr></table>
</div>
</div><p>装上这两条</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-ofctl add-flow s1 tcp,tp_dst<span class="o">=</span>21,actions<span class="o">=</span>set_queue:1,normal

ovs-ofctl add-flow s1 tcp,tp_dst<span class="o">=</span>80,actions<span class="o">=</span>set_queue:2,normal
</code></pre></td></tr></table>
</div>
</div><p>验证一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~#  ovs-appctl -t ovs-vswitchd qos/show s1-eth3
QoS: s1-eth3 linux-htb
max-rate: <span class="m">100000000</span>

Default:
  burst: <span class="m">12512</span>
  min-rate: <span class="m">12000</span>
  max-rate: <span class="m">100000000</span>
  tx_packets: <span class="m">83014</span>
  tx_bytes: <span class="m">125671972</span>
  tx_errors: <span class="m">0</span>

Queue 1:
  burst: <span class="m">12512</span>
  min-rate: <span class="m">70000000</span>
  max-rate: <span class="m">100000000</span>
  tx_packets: <span class="m">0</span>
  tx_bytes: <span class="m">0</span>
  tx_errors: <span class="m">0</span>

Queue 2:
  burst: <span class="m">12512</span>
  min-rate: <span class="m">30000000</span>
  max-rate: <span class="m">100000000</span>
  tx_packets: <span class="m">0</span>
  tx_bytes: <span class="m">0</span>
  tx_errors: <span class="m">0</span>

</code></pre></td></tr></table>
</div>
</div><p>数据面验证：</p>
<p>到21端口的流量的保证 70M</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">h1 screen -d -m    iperf -c 10.0.0.2 -i <span class="m">2</span>  -p <span class="m">21</span>  -t <span class="m">600</span>
</code></pre></td></tr></table>
</div>
</div><p>到80端口的流量保证  30 M</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 iperf  -c 10.0.0.4 -t <span class="m">20</span> -p <span class="m">80</span> -i <span class="m">2</span>
------------------------------------------------------------
Client connecting to 10.0.0.4, TCP port <span class="m">80</span>
TCP window size:  <span class="m">408</span> KByte <span class="o">(</span>default<span class="o">)</span>
------------------------------------------------------------
<span class="o">[</span>  3<span class="o">]</span> <span class="nb">local</span> 10.0.0.1 port <span class="m">33916</span> connected with 10.0.0.4 port <span class="m">80</span>
<span class="o">[</span> ID<span class="o">]</span> Interval       Transfer     Bandwidth
<span class="o">[</span>  3<span class="o">]</span>  0.0- 2.0 sec  7.38 MBytes  30.9 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span>  2.0- 4.0 sec  6.75 MBytes  28.3 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span>  4.0- 6.0 sec  6.88 MBytes  28.8 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span>  6.0- 8.0 sec  7.00 MBytes  29.4 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span>  8.0-10.0 sec  6.62 MBytes  27.8 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span> 10.0-12.0 sec  6.88 MBytes  28.8 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span> 12.0-14.0 sec  7.00 MBytes  29.4 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span> 14.0-16.0 sec  6.62 MBytes  27.8 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span> 16.0-18.0 sec  6.88 MBytes  28.8 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span> 18.0-20.0 sec  7.00 MBytes  29.4 Mbits/sec
<span class="o">[</span>  3<span class="o">]</span>  0.0-20.0 sec  69.0 MBytes  28.9 Mbits/sec

</code></pre></td></tr></table>
</div>
</div><h3 id="ovs-kernel-datapath">ovs Kernel Datapath</h3>
<p>架构</p>
<p><img src="../images/image-20211105155921238.png" alt="image-20211105155921238"></p>
<p>slow path 和fast path</p>
<p><img src="../images/image-20211105160007808.png" alt="image-20211105160007808"></p>
<h4 id="拓扑-1">拓扑</h4>
<p><img src="../images/image-20211105160039260.png" alt="image-20211105160039260"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"> ovs-dpctl dump-dps
</code></pre></td></tr></table>
</div>
</div><p>system@ovs-system 这个是默认的datapaths，保存有内核的flow table</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~# ovs-appctl dpif/show-dp-features s1
Masked <span class="nb">set</span> action: Yes
Tunnel push pop: No
Ufid: Yes
Truncate action: Yes
Clone action: Yes
Sample nesting: <span class="m">10</span>
Conntrack eventmask: Yes
Conntrack clear: Yes
Max dp_hash algorithm: <span class="m">0</span>
Check pkt length action: Yes
Conntrack timeout policy: Yes
Explicit Drop action: No
Max VLAN headers: <span class="m">2</span>
Max MPLS depth: <span class="m">1</span>
Recirc: Yes
CT state: Yes
CT zone: Yes
CT mark: Yes
CT label: Yes
CT state NAT: Yes
CT orig tuple: Yes
CT orig tuple <span class="k">for</span> IPv6: Yes
IPv6 ND Extension: No

</code></pre></td></tr></table>
</div>
</div><p>展示datapath 相关特性</p>
<p>下面dump flow。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~#  ovs-ofctl dump-flows s1
 <span class="nv">cookie</span><span class="o">=</span>0x0, <span class="nv">duration</span><span class="o">=</span>904.316s, <span class="nv">table</span><span class="o">=</span>0, <span class="nv">n_packets</span><span class="o">=</span>36, <span class="nv">n_bytes</span><span class="o">=</span>2748, <span class="nv">priority</span><span class="o">=</span><span class="m">0</span> <span class="nv">actions</span><span class="o">=</span>NORMAL

</code></pre></td></tr></table>
</div>
</div><p>A normal action allows the device to conduct normal layer 2/layer 3 packet processing</p>
<p>下面查看kernel flow</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~# ovs-dpctl dump-flows
root@testovs:~#
</code></pre></td></tr></table>
</div>
</div><p>现在kernel flow是空的。</p>
<h4 id="验证-2">验证</h4>
<p>开始ping</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping h2
PING 10.0.0.2 <span class="o">(</span>10.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.443 ms
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.072 ms
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.053 ms
</code></pre></td></tr></table>
</div>
</div><p>show</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~# ovs-dpctl show
system@ovs-system:
  lookups: hit:186 missed:66 lost:0
  flows: <span class="m">8</span>
  masks: hit:253 total:2 hit/pkt:1.00
  port 0: ovs-system <span class="o">(</span>internal<span class="o">)</span>
  port 1: s1-eth2
  port 2: s1-eth1
  port 3: s1 <span class="o">(</span>internal<span class="o">)</span>
  port 4: s2-eth2
  port 5: s2-eth1
  port 6: s2 <span class="o">(</span>internal<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，内核中加了8条流表。</p>
<p>查看kernel中新加的流表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~# ovs-dpctl dump-flows
recirc_id<span class="o">(</span>0<span class="o">)</span>,in_port<span class="o">(</span>4<span class="o">)</span>,eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>5e:c7:f5:c5:95:00,dst<span class="o">=</span>32:dd:62:89:48:20<span class="o">)</span>,eth_type<span class="o">(</span>0x0800<span class="o">)</span>,ipv4<span class="o">(</span><span class="nv">frag</span><span class="o">=</span>no<span class="o">)</span>, packets:2
, bytes:196, used:0.904s, actions:5
recirc_id<span class="o">(</span>0<span class="o">)</span>,in_port<span class="o">(</span>5<span class="o">)</span>,eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>32:dd:62:89:48:20,dst<span class="o">=</span>5e:c7:f5:c5:95:00<span class="o">)</span>,eth_type<span class="o">(</span>0x0800<span class="o">)</span>,ipv4<span class="o">(</span><span class="nv">frag</span><span class="o">=</span>no<span class="o">)</span>, packets:2
, bytes:196, used:0.904s, actions:4
recirc_id<span class="o">(</span>0<span class="o">)</span>,in_port<span class="o">(</span>1<span class="o">)</span>,eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>32:dd:62:89:48:20,dst<span class="o">=</span>5e:c7:f5:c5:95:00<span class="o">)</span>,eth_type<span class="o">(</span>0x0800<span class="o">)</span>,ipv4<span class="o">(</span><span class="nv">frag</span><span class="o">=</span>no<span class="o">)</span>, packets:2
, bytes:196, used:0.904s, actions:2
recirc_id<span class="o">(</span>0<span class="o">)</span>,in_port<span class="o">(</span>1<span class="o">)</span>,eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>32:dd:62:89:48:20,dst<span class="o">=</span>5e:c7:f5:c5:95:00<span class="o">)</span>,eth_type<span class="o">(</span>0x0806<span class="o">)</span>, packets:0, bytes:0, use
d:never, actions:2
recirc_id<span class="o">(</span>0<span class="o">)</span>,in_port<span class="o">(</span>4<span class="o">)</span>,eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>5e:c7:f5:c5:95:00,dst<span class="o">=</span>ff:ff:ff:ff:ff:ff<span class="o">)</span>,eth_type<span class="o">(</span>0x0806<span class="o">)</span>,arp<span class="o">(</span><span class="nv">sip</span><span class="o">=</span>10.0.0.1,tip<span class="o">=</span>10.
0.0.2,op<span class="o">=</span>1/0xff<span class="o">)</span>, packets:0, bytes:0, used:never, actions:5,6
recirc_id<span class="o">(</span>0<span class="o">)</span>,in_port<span class="o">(</span>5<span class="o">)</span>,eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>32:dd:62:89:48:20,dst<span class="o">=</span>5e:c7:f5:c5:95:00<span class="o">)</span>,eth_type<span class="o">(</span>0x0806<span class="o">)</span>, packets:0, bytes:0, use
d:never, actions:4
recirc_id<span class="o">(</span>0<span class="o">)</span>,in_port<span class="o">(</span>2<span class="o">)</span>,eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>5e:c7:f5:c5:95:00,dst<span class="o">=</span>ff:ff:ff:ff:ff:ff<span class="o">)</span>,eth_type<span class="o">(</span>0x0806<span class="o">)</span>,arp<span class="o">(</span><span class="nv">sip</span><span class="o">=</span>10.0.0.1,tip<span class="o">=</span>10.
0.0.2,op<span class="o">=</span>1/0xff<span class="o">)</span>, packets:0, bytes:0, used:never, actions:3,1
recirc_id<span class="o">(</span>0<span class="o">)</span>,in_port<span class="o">(</span>2<span class="o">)</span>,eth<span class="o">(</span><span class="nv">src</span><span class="o">=</span>5e:c7:f5:c5:95:00,dst<span class="o">=</span>32:dd:62:89:48:20<span class="o">)</span>,eth_type<span class="o">(</span>0x0800<span class="o">)</span>,ipv4<span class="o">(</span><span class="nv">frag</span><span class="o">=</span>no<span class="o">)</span>, packets:2
, bytes:196, used:0.904s, actions:1

</code></pre></td></tr></table>
</div>
</div><p>eth_type=0x0800 ip packet</p>
<p>eth_type=0x0806 arp 请求</p>
<p>下一个 iperf 实验</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~# ovs-dpctl show
system@ovs-system:
  lookups: hit:2697214 missed:136 lost:0
  flows: <span class="m">0</span>
  masks: hit:3830443 total:0 hit/pkt:1.42
  port 0: ovs-system <span class="o">(</span>internal<span class="o">)</span>
  port 1: s1-eth2
  port 2: s1-eth1
  port 3: s1 <span class="o">(</span>internal<span class="o">)</span>
  port 4: s2-eth2
  port 5: s2-eth1
  port 6: s2 <span class="o">(</span>internal<span class="o">)</span>
root@testovs:~#

</code></pre></td></tr></table>
</div>
</div><p>hit 是指包match 已经存在的flow</p>
<p>missed 指包没有match到存在的flow，再到userspace处理</p>
<p>lost是指本想到用户态去处理的，结果被丢弃了的包数量</p>
<h3 id="vlan">vlan</h3>
<p>VLAN ID (VID): A 12-bit VLAN identification number that supports up to 4096 VLAN IDs.</p>
<p><img src="../images/image-20211105163909565.png" alt="image-20211105163909565"></p>
<h4 id="拓扑-2">拓扑</h4>
<p><img src="../images/image-20211105164024309.png" alt="image-20211105164024309"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mn  --topo single,4

mininet&gt; links
h1-eth0&lt;-&gt;s1-eth1 <span class="o">(</span>OK OK<span class="o">)</span>
h2-eth0&lt;-&gt;s1-eth2 <span class="o">(</span>OK OK<span class="o">)</span>
h3-eth0&lt;-&gt;s1-eth3 <span class="o">(</span>OK OK<span class="o">)</span>
h4-eth0&lt;-&gt;s1-eth4 <span class="o">(</span>OK OK<span class="o">)</span>
mininet&gt;
</code></pre></td></tr></table>
</div>
</div><h4 id="配置-1">配置</h4>
<p>增加vlan tag</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl <span class="nb">set</span> port s1-eth1 <span class="nv">tag</span><span class="o">=</span><span class="m">10</span>
ovs-vsctl <span class="nb">set</span> port s1-eth2 <span class="nv">tag</span><span class="o">=</span><span class="m">20</span>

ovs-vsctl <span class="nb">set</span> port s1-eth3 <span class="nv">tag</span><span class="o">=</span><span class="m">10</span>
ovs-vsctl <span class="nb">set</span> port s1-eth4 <span class="nv">tag</span><span class="o">=</span><span class="m">20</span>
</code></pre></td></tr></table>
</div>
</div><p>要删除的话，可以用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl remove port s1-eth1 tag <span class="m">10</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="验证-3">验证</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~#  ovs-vsctl show
fc5561c5-39b2-441f-8077-a933c18acce6
    Bridge s1
        Controller <span class="s2">&#34;ptcp:6654&#34;</span>
        fail_mode: standalone
        Port s1-eth4
            tag: <span class="m">20</span>
            Interface s1-eth4
        Port s1-eth1
            tag: <span class="m">10</span>
            Interface s1-eth1
        Port s1
            Interface s1
                type: internal
        Port s1-eth3
            tag: <span class="m">10</span>
            Interface s1-eth3
        Port s1-eth2
            tag: <span class="m">20</span>
            Interface s1-eth2
    ovs_version: <span class="s2">&#34;2.13.3&#34;</span>
root@testovs:~#

</code></pre></td></tr></table>
</div>
</div><p>测试一下结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping h2
PING 10.0.0.2 <span class="o">(</span>10.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
^C
--- 10.0.0.2 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 0ms

mininet&gt; h1 ping h3
PING 10.0.0.3 <span class="o">(</span>10.0.0.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.510 ms
^C
--- 10.0.0.3 ping statistics ---
<span class="m">1</span> packets transmitted, <span class="m">1</span> received, 0% packet loss, <span class="nb">time</span> 0ms
rtt min/avg/max/mdev <span class="o">=</span> 0.510/0.510/0.510/0.000 ms
mininet&gt; h2 ping h4
PING 10.0.0.4 <span class="o">(</span>10.0.0.4<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.4: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.595 ms
<span class="m">64</span> bytes from 10.0.0.4: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.095 ms
^C
--- 10.0.0.4 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1007ms
rtt min/avg/max/mdev <span class="o">=</span> 0.095/0.345/0.595/0.250 ms
mininet&gt;

</code></pre></td></tr></table>
</div>
</div><p>再用这个看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@testovs:~# ovs-appctl fdb/show s1
 port  VLAN  MAC                Age
    <span class="m">4</span>    <span class="m">20</span>  aa🆎b0:c0:9f:df   <span class="m">44</span>
    <span class="m">1</span>    <span class="m">10</span>  3e:6c:07:e0:b9:17   <span class="m">36</span>
    <span class="m">3</span>    <span class="m">10</span>  e2:0a:56:3d:90:75   <span class="m">24</span>
    <span class="m">2</span>    <span class="m">20</span>  22:3b:8b:2b:02:74    <span class="m">8</span>

</code></pre></td></tr></table>
</div>
</div><p>这个表展示的是，switch s1学习到的 mac 地址、vlan tag</p>
<p>mac 表每60秒变化一次。</p>
<h3 id="vlan-端口聚合-trunking">VLAN 端口聚合 (Trunking)</h3>
<p><img src="../images/image-20211108104131405.png" alt="image-20211108104131405"></p>
<h4 id="拓扑-3">拓扑</h4>
<p><img src="../images/image-20211108104548682.png" alt="image-20211108104548682"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">mininet.topo</span> <span class="kn">import</span> <span class="n">Topo</span>

<span class="k">class</span> <span class="nc">MyTopo</span><span class="p">(</span> <span class="n">Topo</span> <span class="p">):</span>
    <span class="s2">&#34;Simple topology example.&#34;</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="s2">&#34;Create custom topo.&#34;</span>

        <span class="c1"># Add hosts and switches</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h1&#39;</span> <span class="p">,</span><span class="n">ip</span><span class="o">=</span><span class="s1">&#39;10.0.0.1/24&#39;</span><span class="p">)</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h2&#39;</span> <span class="p">,</span><span class="n">ip</span><span class="o">=</span><span class="s1">&#39;20.0.0.1/24&#39;</span> <span class="p">)</span>
        <span class="n">h3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h3&#39;</span> <span class="p">,</span><span class="n">ip</span><span class="o">=</span><span class="s1">&#39;10.0.0.2/24&#39;</span><span class="p">)</span>
        <span class="n">h4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addHost</span><span class="p">(</span> <span class="s1">&#39;h4&#39;</span> <span class="p">,</span><span class="n">ip</span><span class="o">=</span><span class="s1">&#39;20.0.0.2/24&#39;</span><span class="p">)</span>

        <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span> <span class="s1">&#39;s1&#39;</span> <span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span> <span class="s1">&#39;s2&#39;</span> <span class="p">)</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitch</span><span class="p">(</span> <span class="s1">&#39;s3&#39;</span> <span class="p">)</span>

        <span class="c1"># Add links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h1</span><span class="p">,</span> <span class="n">s1</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h2</span><span class="p">,</span> <span class="n">s1</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h3</span><span class="p">,</span> <span class="n">s2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">h4</span><span class="p">,</span> <span class="n">s2</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s3</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span> <span class="p">)</span>


<span class="n">topos</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;mytopo&#39;</span><span class="p">:</span> <span class="p">(</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">MyTopo</span><span class="p">()</span> <span class="p">)</span> <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>mininet启动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"> mn --custom vlan-trunk.py  --topo mytopo
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">links</span>
<span class="n">h1</span><span class="o">-</span><span class="n">eth0</span><span class="o">&lt;-&gt;</span><span class="n">s1</span><span class="o">-</span><span class="n">eth1</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">h2</span><span class="o">-</span><span class="n">eth0</span><span class="o">&lt;-&gt;</span><span class="n">s1</span><span class="o">-</span><span class="n">eth2</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">h3</span><span class="o">-</span><span class="n">eth0</span><span class="o">&lt;-&gt;</span><span class="n">s2</span><span class="o">-</span><span class="n">eth1</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">h4</span><span class="o">-</span><span class="n">eth0</span><span class="o">&lt;-&gt;</span><span class="n">s2</span><span class="o">-</span><span class="n">eth2</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">s1</span><span class="o">-</span><span class="n">eth3</span><span class="o">&lt;-&gt;</span><span class="n">s3</span><span class="o">-</span><span class="n">eth1</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">s2</span><span class="o">-</span><span class="n">eth3</span><span class="o">&lt;-&gt;</span><span class="n">s3</span><span class="o">-</span><span class="n">eth2</span> <span class="p">(</span><span class="n">OK</span> <span class="n">OK</span><span class="p">)</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">nodes</span>
<span class="n">available</span> <span class="n">nodes</span> <span class="n">are</span><span class="p">:</span>
<span class="n">h1</span> <span class="n">h2</span> <span class="n">h3</span> <span class="n">h4</span> <span class="n">s1</span> <span class="n">s2</span> <span class="n">s3</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">dump</span>
<span class="o">&lt;</span><span class="n">Host</span> <span class="n">h1</span><span class="p">:</span> <span class="n">h1</span><span class="o">-</span><span class="n">eth0</span><span class="p">:</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">pid</span><span class="o">=</span><span class="mi">31074</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Host</span> <span class="n">h2</span><span class="p">:</span> <span class="n">h2</span><span class="o">-</span><span class="n">eth0</span><span class="p">:</span><span class="mf">20.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">pid</span><span class="o">=</span><span class="mi">31076</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Host</span> <span class="n">h3</span><span class="p">:</span> <span class="n">h3</span><span class="o">-</span><span class="n">eth0</span><span class="p">:</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">pid</span><span class="o">=</span><span class="mi">31078</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Host</span> <span class="n">h4</span><span class="p">:</span> <span class="n">h4</span><span class="o">-</span><span class="n">eth0</span><span class="p">:</span><span class="mf">20.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">pid</span><span class="o">=</span><span class="mi">31080</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">OVSBridge</span> <span class="n">s1</span><span class="p">:</span> <span class="n">lo</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span><span class="n">s1</span><span class="o">-</span><span class="n">eth1</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="n">s1</span><span class="o">-</span><span class="n">eth2</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="n">s1</span><span class="o">-</span><span class="n">eth3</span><span class="p">:</span><span class="bp">None</span> <span class="n">pid</span><span class="o">=</span><span class="mi">31085</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">OVSBridge</span> <span class="n">s2</span><span class="p">:</span> <span class="n">lo</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span><span class="n">s2</span><span class="o">-</span><span class="n">eth1</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="n">s2</span><span class="o">-</span><span class="n">eth2</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="n">s2</span><span class="o">-</span><span class="n">eth3</span><span class="p">:</span><span class="bp">None</span> <span class="n">pid</span><span class="o">=</span><span class="mi">31088</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">OVSBridge</span> <span class="n">s3</span><span class="p">:</span> <span class="n">lo</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span><span class="n">s3</span><span class="o">-</span><span class="n">eth1</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="n">s3</span><span class="o">-</span><span class="n">eth2</span><span class="p">:</span><span class="bp">None</span> <span class="n">pid</span><span class="o">=</span><span class="mi">31091</span><span class="o">&gt;</span>
<span class="n">mininet</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="配置vlan">配置vlan</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ovs-vsctl <span class="nb">set</span> port s1-eth1 <span class="nv">tag</span><span class="o">=</span><span class="m">10</span>
ovs-vsctl <span class="nb">set</span> port s1-eth2 <span class="nv">tag</span><span class="o">=</span><span class="m">20</span>
ovs-vsctl <span class="nb">set</span> port s1-eth3 <span class="nv">trunk</span><span class="o">=</span>10,20

ovs-vsctl <span class="nb">set</span> port s2-eth1 <span class="nv">tag</span><span class="o">=</span><span class="m">10</span>
ovs-vsctl <span class="nb">set</span> port s2-eth2 <span class="nv">tag</span><span class="o">=</span><span class="m">20</span>
ovs-vsctl <span class="nb">set</span> port s2-eth3 <span class="nv">trunk</span><span class="o">=</span>10,20
</code></pre></td></tr></table>
</div>
</div><h4 id="验证-4">验证</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mininet&gt; h1 ping h2
ping: connect: Network is unreachable

mininet&gt; h1 ping h3
PING 10.0.0.2 <span class="o">(</span>10.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.00 ms
<span class="m">64</span> bytes from 10.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.070 ms
^C
--- 10.0.0.2 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1001ms
rtt min/avg/max/mdev <span class="o">=</span> 0.070/0.536/1.003/0.466 ms

mininet&gt; h1 ping h4
ping: connect: Network is unreachable


mininet&gt; h2 ping h4
PING 20.0.0.2 <span class="o">(</span>20.0.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 20.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.748 ms
<span class="m">64</span> bytes from 20.0.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.066 ms
^C
--- 20.0.0.2 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1020ms
rtt min/avg/max/mdev <span class="o">=</span> 0.066/0.407/0.748/0.341 ms
</code></pre></td></tr></table>
</div>
</div><p>可以用这个 ovs-vsctl show 看一下。</p>
<h3 id="实现gre-tunnel">实现gre tunnel</h3>
<h4 id="gre-报文头">gre 报文头</h4>
<p><img src="../images/image-20211108143942516.png" alt="image-20211108143942516"></p>
<p>GRE header (4-bytes long)</p>
<p>outer IP header (20-bytes long).</p>
<h4 id="拓扑-4">拓扑</h4>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">smasterfree</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2022-01-24
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/gopacket-%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">gopacket 解析报文优化思路</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/go%E8%A7%A3%E6%9E%90%E5%A4%A7%E6%96%87%E4%BB%B6%E4%BC%98%E5%8C%96/">
            <span class="next-text nav-default">go 解析大文本文件9种优化方式</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2015 - 
    2023
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">smasterfree</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.2517c0eb67172a0bae917de4af59b10ca2531411a009d4c0b82f5685259e5771.js"></script>








</body>
</html>
